<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Noxhaven: Blood & Empire - Market Update</title>
    <!-- Externe Icon Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #050505;
            --panel: #0a0a0a;
            --card: #141414;
            --border: #262626;
            --blood: #b91c1c; 
            --gold: #c6a306;  
            --cold: #2563eb;  
            --purple: #9333ea; 
            --green: #16a34a; 
            --police: #1e40af;
            --dirty: #71717a;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --font-main: 'Georgia', serif;
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text-main); 
            font-family: var(--font-ui); height: 100dvh; display: flex; flex-direction: column; 
            overflow: hidden; 
            overscroll-behavior: none; 
        }
        
        #app { 
            display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; 
            background: var(--panel); border-left: 1px solid var(--border); border-right: 1px solid var(--border); 
            position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.6); width: 100%;
        }
        
        header { 
            flex: 0 0 auto; 
            padding: 12px 16px; 
            padding-top: max(12px, env(safe-area-inset-top)); 
            border-bottom: 1px solid var(--border); 
            background: linear-gradient(to bottom, #111, #0a0a0a); 
        }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .logo { font-family: var(--font-main); font-size: 1.4rem; color: var(--blood); text-transform: uppercase; letter-spacing: 3px; font-weight: bold; text-shadow: 0 0 10px rgba(185, 28, 28, 0.3); }
        .rank-display { font-size: 0.65rem; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-top: 2px; }
        
        .resource-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .res-item { 
            background: #111; padding: 6px 4px; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; gap: 2px; 
            font-size: 0.65rem; border: 1px solid var(--border); transition: 0.2s;
        }
        .res-label { font-size: 0.5rem; color: #777; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 2px; }
        .res-row { display: flex; align-items: center; gap: 3px; }
        .res-val { font-weight: 700; color: #fff; font-size: 0.8rem; }
        .dirty-val { color: var(--dirty); font-size: 0.55rem; font-weight: 600; }

        .clickable-stat { cursor: pointer; border-bottom: 1px dashed var(--blood); }
        .clickable-stat:active { opacity: 0.7; }

        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 16px; 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .news-ticker { 
            background: #000; border: 1px solid var(--border); border-radius: 4px; 
            padding: 6px 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 0;
            overflow: hidden; position: relative; font-family: 'Courier New', monospace;
        }
        .news-label { 
            color: var(--blood); font-weight: bold; font-size: 0.7rem; text-transform: uppercase; 
            border-right: 1px solid #333; padding-right: 10px; flex-shrink: 0; 
            background: #000; z-index: 2; position: relative;
        }
        .news-scroll-wrap { flex: 1; overflow: hidden; position: relative; margin-left: 10px; display: flex; align-items: center; }
        .news-content { font-size: 0.75rem; color: #aaa; white-space: nowrap; animation: scroll-news 25s linear infinite; display: inline-block; }
        @keyframes scroll-news { 0% { transform: translateX(100%); } 100% { transform: translateX(-150%); } }

        /* Animation for Combat Shake */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1px); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-anim { animation: shake 0.5s; }

        /* Casino Styles */
        .casino-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .game-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .game-card:hover { border-color: var(--gold); background: #222; }
        .game-icon { color: var(--gold); margin-bottom: 10px; }
        
        .playing-card { display: inline-block; width: 40px; height: 56px; background: #eee; color: #000; border-radius: 4px; margin: 2px; line-height: 56px; text-align: center; font-weight: 800; font-family: 'Courier New', monospace; box-shadow: 1px 1px 4px rgba(0,0,0,0.6); font-size: 1.1rem; border: 2px solid #fff; }
        .playing-card.red { color: var(--blood); }
        .playing-card.black { color: #000; }
        .playing-card.back { background: repeating-linear-gradient(45deg, #b91c1c, #b91c1c 5px, #991b1b 5px, #991b1b 10px); color: transparent; border-color: #881313; }

        .slot-reel { display: inline-block; width: 60px; height: 70px; background: #000; border: 2px solid var(--gold); color: #fff; line-height: 70px; font-size: 32px; margin: 4px; border-radius: 6px; text-align: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
        .roulette-btn { flex: 1; padding: 15px 5px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); }
        .r-red { background: var(--blood); color: white; }
        .r-black { background: #111; color: white; }
        .r-green { background: var(--green); color: white; border: 1px solid var(--gold); }

        /* COMBAT ARENA STYLES */
        .combat-arena { background: #080808; padding: 10px; border-radius: 8px; border: 1px solid #333; margin-bottom: 10px; }
        .combat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .fighter { flex: 1; text-align: center; }
        .fighter-name { font-size: 0.75rem; font-weight: bold; color: #fff; margin-bottom: 4px; text-transform: uppercase; }
        .hp-bar-wrap { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-bar { height: 100%; background: var(--green); transition: width 0.3s ease; }
        .hp-bar.enemy-bar { background: var(--blood); }
        .hp-text { font-size: 0.6rem; color: #888; margin-top: 2px; font-weight: 600; }
        .vs-badge { font-family: var(--font-main); color: var(--gold); font-weight: bold; font-size: 1.2rem; margin: 0 10px; text-shadow: 0 0 5px rgba(198, 163, 6, 0.5); }
        
        .combat-actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .combat-btn { 
            background: #1a1a1a; border: 1px solid #333; color: #eee; padding: 12px; border-radius: 6px; 
            cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s;
            position: relative; overflow: hidden;
        }
        .combat-btn:active { transform: scale(0.96); border-color: var(--gold); }
        .combat-btn:hover { background: #222; border-color: #555; }
        .combat-btn i { margin-bottom: 2px; color: var(--gold); }
        .combat-btn-label { font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
        .combat-btn-sub { font-size: 0.55rem; color: #777; }

        .card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 8px; 
            padding: 12px; margin-bottom: 10px; position: relative; transition: all 0.2s; 
        }
        .card:active { transform: scale(0.99); border-color: var(--blood); }
        .card-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .card-title { font-weight: 700; font-size: 0.95rem; color: #f1f5f9; }
        .card-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 24px 0 12px 0; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
        .section-title { color: var(--gold); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }

        .btn { 
            background: #1f1f1f; border: 1px solid #333; color: #e2e8f0; padding: 12px 14px; 
            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.75rem; 
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; 
            min-height: 44px; 
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-action { background: var(--blood); color: #fff; border: none; width: 100%; padding: 14px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .btn-gold { border-color: var(--gold); color: var(--gold); background: rgba(198, 163, 6, 0.1); }
        .btn-choice { background: #1a1a1a; border: 1px solid var(--border); text-align: left; padding: 12px; border-radius: 6px; margin-bottom: 8px; width: 100%; display: block; font-size: 0.8rem; line-height: 1.4; color: #ddd; }
        .btn-choice:hover { border-color: var(--gold); background: #222; }
        .btn-sm { padding: 8px 12px; font-size: 0.7rem; min-height: 32px; } 
        .btn-heal { border-color: var(--green); color: var(--green); background: rgba(22, 163, 74, 0.1); }
        .btn-danger { border-color: var(--blood); color: var(--blood); background: rgba(185, 28, 28, 0.1); }

        .btn.active-mode { background: var(--gold); color: #000; border-color: var(--gold); }

        .market-item-grid { display: grid; grid-template-columns: 1fr 100px; gap: 10px; align-items: center; }
        .price-trend { font-size: 0.65rem; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .trend-up { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .trend-down { color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .demand-tag { font-size: 0.6rem; color: var(--gold); border: 1px solid var(--gold); padding: 1px 4px; border-radius: 3px; text-transform: uppercase; margin-left: 5px; }

        /* Map Styles */
        #map-container { 
            background: #050505; 
            border: 1px solid var(--border); border-radius: 8px; position: relative; width: 100%; padding-top: 70%; margin-bottom: 16px; overflow: hidden; 
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        }
        .map-grid-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none;
            background-size: 30px 30px;
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            z-index: 1;
        }
        .scanline {
            width: 100%; height: 3px; background: rgba(198, 163, 6, 0.15); position: absolute; top: -10%; left: 0; pointer-events: none; z-index: 2;
            box-shadow: 0 0 10px rgba(198, 163, 6, 0.3);
            animation: scan 5s linear infinite;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }
        
        #map-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        .map-district { 
            fill: url(#building-pattern); stroke: #333; stroke-width: 1; 
            transition: 0.3s ease; cursor: pointer; opacity: 0.7;
        }
        .map-district:hover { stroke: #666; opacity: 1; }
        .map-district.selected { stroke: var(--gold); stroke-width: 2; fill: url(#building-pattern-active); opacity: 1; filter: drop-shadow(0 0 6px rgba(198, 163, 6, 0.3)); }
        .map-district.owned { stroke: var(--blood); stroke-dasharray: 4,2; }
        .map-highway { fill: none; stroke: #1a1a1a; stroke-width: 3; stroke-linecap: round; pointer-events: none; }
        .map-label { 
            font-family: var(--font-ui); font-size: 8px; font-weight: 700; fill: #666; 
            pointer-events: none; text-anchor: middle; letter-spacing: 0.5px; text-transform: uppercase;
        }
        .map-label-bg { fill: rgba(0,0,0,0.8); rx: 3; pointer-events: none; }
        .map-district:hover ~ .map-label-group .map-label, .map-district.selected ~ .map-label-group .map-label { fill: #fff; }
        .map-district.selected ~ .map-label-group .map-label { fill: var(--gold); }
        .player-target-ring { fill: none; stroke: var(--gold); stroke-width: 1.5; }
        .player-target-dot { fill: var(--gold); }
        .player-marker-group { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        .icon-overlay { font-size: 10px; fill: #fff; pointer-events: none; text-anchor: middle; font-family: var(--font-ui); font-weight: bold; filter: drop-shadow(0 1px 2px black); }

        /* RPG & Stats */
        .stat-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 0.75rem; }
        .stat-bar-bg { flex: 1; height: 6px; background: #222; border-radius: 3px; margin: 0 10px; overflow: hidden; }
        .stat-bar-fill { height: 100%; transition: width 0.3s; }
        .stat-val { font-weight: bold; width: 25px; text-align: right; color: #fff; }
        .stat-btn { background: #222; border: 1px solid var(--gold); color: var(--gold); width: 18px; height: 18px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
        
        .equip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .equip-slot { aspect-ratio: 1; background: #0f0f0f; border: 1px dashed #333; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; font-size: 0.65rem; position: relative; cursor: pointer; transition: 0.2s; }
        .equip-slot.filled { border-style: solid; border-color: var(--gold); background: rgba(198, 163, 6, 0.05); color: #eee; }
        .equip-icon { margin-bottom: 4px; }
        .equip-label { font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.5px; }

        nav { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            min-height: 65px; height: auto; 
            padding-bottom: env(safe-area-inset-bottom);
            background: rgba(10, 10, 10, 0.98); border-top: 1px solid var(--border); 
            display: flex; justify-content: space-around; align-items: center; z-index: 1000; 
            overflow-x: auto; /* Allow scrolling if too wide */
        }
        .nav-btn { 
            background: none; border: none; color: #555; display: flex; flex-direction: column; 
            align-items: center; gap: 4px; font-size: 0.6rem; cursor: pointer; transition: 0.2s; 
            font-weight: 600; padding: 10px 0; min-width: 60px; flex: 1;
        }
        .nav-btn.active { color: var(--gold); }
        .nav-btn i { stroke-width: 2px; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal { background: #0a0a0a; width: 100%; max-width: 450px; padding: 20px; border: 1px solid var(--border); border-radius: 12px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-title { color: var(--blood); font-size: 1.2rem; margin-bottom: 10px; font-family: var(--font-main); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        
        .combat-log { 
            background: #000; border: 1px solid #222; border-radius: 4px; padding: 10px; 
            height: 120px; overflow-y: auto; font-family: 'Courier New', monospace; 
            font-size: 0.7rem; color: #00ff00; margin: 10px 0; line-height: 1.4; scroll-behavior: smooth;
        }
        .combat-stance-btn { padding: 15px; border: 1px solid #333; border-radius: 6px; text-align: left; background: #111; cursor: pointer; transition: 0.2s; width: 100%; box-sizing: border-box; }
        .combat-stance-btn:hover { border-color: var(--gold); background: #1a1a1a; }
        .combat-stance-title { font-weight: bold; font-size: 0.8rem; color: #fff; margin-bottom: 2px; }
        .combat-stance-desc { font-size: 0.65rem; color: #888; }

        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: #111; color: #fff; padding: 12px 24px; border-radius: 6px; 
            border: 1px solid var(--gold); font-weight: 600; z-index: 9999; display: none; 
            font-size: 0.8rem; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center;
        }
        .toast-red { border-color: var(--blood) !important; color: #ffadad !important; }
        
        .progress-container { height: 4px; background: #222; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .hidden { display: none !important; }

        .contract-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; text-transform: uppercase; font-weight: bold; }
        .faction-tag { padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.6rem; color: #fff; text-shadow: 0 1px 2px #000; }

        #start-screen {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a0000 0%, #000 100%);
            z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>

<div id="start-screen">
    <div id="menu-main" class="start-nav" style="width:100%; max-width:320px; text-align:center;">
        <div style="margin-bottom: 40px;">
            <div style="font-family: var(--font-main); color: var(--blood); font-size: 3.5rem; font-weight: bold; letter-spacing: 8px; margin-bottom: 5px; text-shadow: 0 0 30px rgba(185, 28, 28, 0.6);">NOXHAVEN</div>
            <div style="color: var(--gold); letter-spacing: 4px; font-size: 0.8rem; font-weight: 600; opacity: 0.8;">KINGPIN UPDATE</div>
            <div style="color: #666; font-size: 0.6rem; margin-top:5px;">V6.4 (MARKET FIXED)</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:12px;">
            <button class="btn btn-action" onclick="window.UI.showDifficulty()">NIEUWE OPERATIE</button>
            <button class="btn" onclick="window.UI.showTutorial()">HOE TE SPELEN</button>
            <button class="btn btn-gold" style="font-size:0.7rem;" onclick="window.Engine.exportSave()">EXPORT SAVE (BACKUP)</button>
            <button class="btn" style="opacity:0.5; font-size:0.65rem;" onclick="window.Engine.reset()">RESET OPSLAG</button>
        </div>
    </div>

    <div id="menu-difficulty" class="start-nav hidden" style="width:100%; max-width:320px;">
        <div style="color: var(--blood); font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; text-align: center;">KIES JE ACHTERGROND</div>
        <button class="btn btn-choice" onclick="window.UI.selectDifficulty('easy')">
            <div style="color: var(--green);">STREET RAT (EASY)</div>
            <div class="difficulty-desc" style="font-size:0.7rem; color:#888;">Start: €10k, Geen schuld.</div>
        </button>
        <button class="btn btn-choice" onclick="window.UI.selectDifficulty('normal')">
            <div style="color: var(--gold);">ASSOCIATE (NORMAL)</div>
            <div class="difficulty-desc" style="font-size:0.7rem; color:#888;">Start: €5k, €12k schuld.</div>
        </button>
        <button class="btn btn-choice" onclick="window.UI.selectDifficulty('hard')">
            <div style="color: var(--blood);">OUTCAST (HARD)</div>
            <div class="difficulty-desc" style="font-size:0.7rem; color:#888;">Start: €1.5k, €25k schuld, +Heat.</div>
        </button>
        <button class="btn" style="margin-top: 10px; width:100%;" onclick="window.UI.hideDifficulty()">TERUG</button>
    </div>
</div>

<div id="app" class="hidden">
    <header>
        <div class="header-top">
            <div>
                <span class="logo">NOXHAVEN</span>
                <div id="ui-rank" class="rank-display">LOOPJONGEN</div>
            </div>
            <div style="text-align:right;">
                <span id="ui-date" style="color:var(--gold); font-family:var(--font-main); font-weight:bold;">DAG 1</span>
                <div style="font-size:0.6rem; color:var(--blood); margin-top:2px; font-weight:bold;">
                    SCHULD: €<span id="ui-debt" class="clickable-stat" onclick="window.Engine.promptPayDebt()">12.000</span>
                </div>
            </div>
        </div>
        <div class="resource-bar">
            <div class="res-item">
                <span class="res-label">CASH</span>
                <div class="res-row">
                    <i data-lucide="banknote" size="12" style="color:var(--gold)"></i>
                    <span class="res-val" id="ui-money">0</span>
                </div>
                <div class="dirty-val" id="ui-dirty-money">€0</div>
            </div>
            <div class="res-item">
                <span class="res-label">REP</span>
                <div class="res-row">
                    <i data-lucide="shield" size="12" style="color:var(--purple)"></i>
                    <span class="res-val" id="ui-rep">0</span>
                </div>
            </div>
            <div class="res-item">
                <span class="res-label">HEAT</span>
                <div class="res-row">
                    <i data-lucide="siren" size="12" style="color:var(--blood)"></i>
                    <span class="res-val" id="ui-heat">0%</span>
                </div>
            </div>
            <div class="res-item">
                <span class="res-label">HP</span>
                <div class="res-row">
                    <i data-lucide="heart" size="12" style="color:var(--green)"></i>
                    <span class="res-val" id="ui-hp">100</span>
                </div>
            </div>
        </div>
    </header>

    <main id="game-main">
        <div id="view-city" class="view-section">
            <div class="news-ticker">
                <span class="news-label">EXTRA</span>
                <div class="news-scroll-wrap">
                    <div class="news-content" id="ui-news">Welkom in Noxhaven. Bouw je imperium.</div>
                </div>
            </div>

            <div id="map-container">
                <div class="map-grid-overlay"></div>
                <div class="scanline"></div>
                <svg id="map-svg" viewBox="0 0 400 300">
                    <defs>
                        <pattern id="building-pattern" width="6" height="6" patternUnits="userSpaceOnUse">
                            <rect width="6" height="6" fill="#111" />
                            <rect width="2" height="2" fill="#181818" x="1" y="1" />
                        </pattern>
                        <pattern id="building-pattern-active" width="6" height="6" patternUnits="userSpaceOnUse">
                            <rect width="6" height="6" fill="#1a1a1a" />
                            <rect width="2" height="2" fill="#2a2a2a" x="1" y="1" />
                        </pattern>
                    </defs>

                    <g class="highways">
                        <path d="M 100 90 L 265 85" class="map-highway" />
                        <path d="M 100 90 L 100 205" class="map-highway" />
                        <path d="M 265 85 L 215 200" class="map-highway" />
                        <path d="M 265 85 L 315 200" class="map-highway" />
                        <path d="M 100 205 L 215 200" class="map-highway" />
                    </g>

                    <!-- Districts -->
                    <g id="g-port" onclick="window.Engine.selectDistrict('port')">
                        <path d="M 40 40 L 160 40 L 160 140 L 40 140 Z" id="map-port" class="map-district"></path>
                        <g class="map-label-group">
                            <rect x="65" y="84" width="70" height="12" class="map-label-bg" />
                            <text x="100" y="93" class="map-label">PORT NERO</text>
                            <text x="100" y="115" id="icon-port" class="icon-overlay"></text>
                        </g>
                    </g>
                    <g id="g-crown" onclick="window.Engine.selectDistrict('crown')">
                        <path d="M 170 40 L 360 40 L 360 130 L 170 130 Z" id="map-crown" class="map-district"></path>
                        <g class="map-label-group">
                             <rect x="225" y="79" width="80" height="12" class="map-label-bg" />
                            <text x="265" y="88" class="map-label">CROWN HEIGHTS</text>
                            <text x="265" y="110" id="icon-crown" class="icon-overlay"></text>
                        </g>
                    </g>
                    <g id="g-iron" onclick="window.Engine.selectDistrict('iron')">
                        <path d="M 170 140 L 260 140 L 260 260 L 170 260 Z" id="map-iron" class="map-district"></path>
                        <g class="map-label-group">
                            <rect x="175" y="194" width="80" height="12" class="map-label-bg" />
                            <text x="215" y="203" class="map-label">IRON BOROUGH</text>
                            <text x="215" y="225" id="icon-iron" class="icon-overlay"></text>
                        </g>
                    </g>
                    <g id="g-low" onclick="window.Engine.selectDistrict('low')">
                        <path d="M 40 150 L 160 150 L 160 260 L 40 260 Z" id="map-low" class="map-district"></path>
                        <g class="map-label-group">
                            <rect x="75" y="199" width="50" height="12" class="map-label-bg" />
                            <text x="100" y="208" class="map-label">LOWRISE</text>
                            <text x="100" y="230" id="icon-low" class="icon-overlay"></text>
                        </g>
                    </g>
                    <g id="g-neon" onclick="window.Engine.selectDistrict('neon')">
                        <path d="M 270 140 L 360 140 L 360 260 L 270 260 Z" id="map-neon" class="map-district"></path>
                        <g class="map-label-group">
                             <rect x="280" y="194" width="70" height="12" class="map-label-bg" />
                            <text x="315" y="203" class="map-label">NEON STRIP</text>
                            <text x="315" y="225" id="icon-neon" class="icon-overlay"></text>
                        </g>
                    </g>
                    
                    <g id="player-marker" class="player-marker-group" transform="translate(0,0)">
                        <circle r="8" class="player-target-ring" stroke-dasharray="4,2"></circle>
                        <circle r="3" class="player-target-dot"></circle>
                    </g>
                </svg>
            </div>
            
            <div id="district-info" class="card" style="border-left: 3px solid var(--blood);">
                <div class="card-row">
                    <div>
                        <div id="dist-name" class="card-title">Selecteer District</div>
                        <div id="dist-bonus" class="card-sub" style="color:var(--gold)">Geen bonus actief</div>
                    </div>
                    <button class="btn btn-gold btn-sm" id="btn-action-district">REIS HIERHEEN</button>
                </div>
            </div>

            <button class="btn btn-action" id="btn-end-turn" onclick="window.Engine.endTurn()">DAG AFSLUITEN</button>
        </div>

        <div id="view-assets" class="view-section hidden">
            <div class="section-header"><span class="section-title">Productie & Vastgoed</span></div>
            <div style="font-size:0.7rem; color:#888; margin-bottom:15px; background:#111; padding:10px; border-radius:4px;">
                Produceer je eigen drugs om de markt te overspoelen.
            </div>

            <div class="card" style="border-left: 3px solid var(--purple);">
                <div class="card-row">
                    <div>
                        <div class="card-title">Synthetica Lab</div>
                        <div class="card-sub" id="lab-status">Niet in bezit</div>
                    </div>
                </div>
                <div id="lab-controls" style="margin-top:10px;"></div>
            </div>

            <div class="section-header"><span class="section-title">Dekmantels</span></div>
            <div id="business-list"></div>
        </div>

        <div id="view-profile" class="view-section hidden">
            <div class="section-header"><span class="section-title">Boss Profiel</span></div>
            <div class="card" style="border-left: 3px solid var(--gold);">
                <div class="card-row">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <div style="width:45px; height:45px; background:#222; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--gold);">
                            <i data-lucide="user" size="24" color="white"></i>
                        </div>
                        <div>
                            <div class="card-title">The Boss</div>
                            <div class="card-sub">Level <span id="ui-lvl">1</span> | Skill Points: <span id="ui-sp" style="color:var(--gold); font-weight:bold;">0</span></div>
                        </div>
                    </div>
                </div>
                <div class="progress-container" style="margin-top:12px;">
                    <div class="progress-fill" id="ui-xp-bar" style="width:0%; background:var(--blood);"></div>
                </div>
                <div style="font-size:0.65rem; text-align:right; margin-top:2px; color:#666;">XP: <span id="ui-xp">0</span> / <span id="ui-xp-next">100</span></div>
            </div>

            <div class="section-header"><span class="section-title">Eigenschappen</span></div>
            <div class="card">
                <div id="stats-list"></div>
            </div>

            <div class="section-header"><span class="section-title">Loadout</span></div>
            <div class="equip-grid">
                <div class="equip-slot" id="slot-weapon" onclick="window.Engine.unequip('weapon')"><span class="equip-label">Wapen</span></div>
                <div class="equip-slot" id="slot-armor" onclick="window.Engine.unequip('armor')"><span class="equip-label">Pantser</span></div>
                <div class="equip-slot" id="slot-gadget" onclick="window.Engine.unequip('gadget')"><span class="equip-label">Gadget</span></div>
            </div>

            <div class="section-header"><span class="section-title">Kluis</span></div>
            <div id="gear-inventory-list"></div>
            
            <button class="btn" style="width:100%; margin-top:20px; opacity: 0.7;" onclick="window.Engine.quitToMenu()">STOPPEN & OPSLAAN</button>
        </div>

        <div id="view-families" class="view-section hidden">
            <div class="section-header"><span class="section-title">Onderwereld & Facties</span></div>
            <div style="font-size:0.7rem; color:#888; margin-bottom:10px;">Reputatie > 50 opent winkels. Reputatie < -20 maakt vijanden.</div>
            <div id="contact-list"></div>
            
            <div class="section-header"><span class="section-title">HQ Upgrades</span></div>
            <div id="hq-list"></div>

            <div class="section-header"><span class="section-title">Corruptie</span></div>
            <div class="card" style="border-left: 3px solid var(--police);">
                <div class="card-row">
                    <div>
                        <div class="card-title">Politie Omkopen</div>
                        <div class="card-sub">Relatie: <span id="ui-police-rel">20</span>/100</div>
                    </div>
                    <button class="btn btn-sm" onclick="window.Engine.bribePolice()">KOOP OM (<span id="ui-bribe-cost">€3.500</span>)</button>
                </div>
            </div>
        </div>

        <div id="view-business" class="view-section hidden">
            <div class="section-header"><span class="section-title">Lokale Markt: <span id="ui-loc-market" style="color:var(--blood)">Noxhaven</span></span></div>
            <div id="ui-market-alert" style="color:var(--gold); font-size:0.7rem; margin-bottom:10px; font-weight:bold; display:none; background:rgba(198,163,6,0.1); padding:8px; border-radius:4px;">⚠️ Je bent hier niet. Reis hierheen om te handelen.</div>
            
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-muted); margin-bottom:10px;">
                <span>BAGAGE: <span id="ui-inv-count">0</span> / <span id="ui-inv-max">15</span> <span id="ui-inv-full" style="color:var(--blood); display:none; font-weight:bold;">(VOL)</span></span>
                <span>MARGE: <span id="ui-trade-bonus">0%</span></span>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <button id="btn-trade-mode-buy" class="btn btn-gold" style="flex:1" onclick="window.UI.setTradeMode('buy')">INKOOP</button>
                <button id="btn-trade-mode-sell" class="btn" style="flex:1" onclick="window.UI.setTradeMode('sell')">VERKOOP</button>
            </div>
            <div id="market-list"></div>
            
            <div class="section-header"><span class="section-title">Witwas Operaties</span></div>
            <div class="card" style="border-left: 3px solid var(--green);">
                <div class="card-row">
                    <div>
                        <div class="card-title">Geld Witwassen</div>
                        <div class="card-sub">Zet Zwart geld om in Schoon geld (15% fee).</div>
                    </div>
                    <button class="btn btn-gold btn-sm" onclick="window.Engine.washMoney()">START WITWAS</button>
                </div>
            </div>
            
            <div class="section-header"><span class="section-title">Zwarte Markt (Gear)</span></div>
            <div id="shop-gear-list"></div>
        </div>

        <div id="view-ops" class="view-section hidden">
            <div class="section-header"><span class="section-title">Mijn Crew</span></div>
            <div style="margin-bottom:10px; background:#111; padding:8px; border-radius:4px; font-size:0.7rem; color:#888;">
                <strong style="color:var(--gold)">ROLLEN:</strong><br>
                • <b>Hacker:</b> Verlaagt Heat sneller (-3 p/n)<br>
                • <b>Enforcer:</b> Doet meer schade in combat<br>
                • <b>Chauffeur:</b> Gratis reizen tussen districten<br>
                • <b>Smokkelaar:</b> +5 Bagageruimte
            </div>
            <div id="crew-list"></div>
            <button class="btn btn-gold" style="width:100%; margin-bottom:20px;" onclick="window.Engine.recruit()">HUUR SPECIALIST (€2.500)</button>
            
            <div class="section-header"><span class="section-title">Dagelijkse Contracten</span></div>
            <div style="font-size:0.7rem; color:#888; margin-bottom:10px;">Contracten veranderen elke nacht.</div>
            <div id="crimes-list"></div>
        </div>

        <div id="view-casino" class="view-section hidden">
            <div class="section-header"><span class="section-title">THE VELVET ROOM</span></div>
            <div style="text-align:center; margin-bottom:20px; color:#888; font-size:0.75rem;">
                "Het huis wint altijd... tenzij jij vals speelt."<br>
                <span style="color:var(--gold); font-size:0.9rem; font-weight:bold;">Beschikbaar: €<span id="ui-casino-money">0</span></span>
            </div>

            <div id="casino-menu" class="casino-grid">
                <div class="game-card" onclick="window.Engine.openGame('blackjack')">
                    <i data-lucide="spade" class="game-icon" size="32"></i>
                    <div style="font-weight:bold; color:#fff;">BLACKJACK</div>
                    <div style="font-size:0.65rem; color:#666;">2x Uitbetaling</div>
                </div>
                <div class="game-card" onclick="window.Engine.openGame('roulette')">
                    <i data-lucide="circle-dot" class="game-icon" size="32"></i>
                    <div style="font-weight:bold; color:#fff;">ROULETTE</div>
                    <div style="font-size:0.65rem; color:#666;">Tot 14x Uitbetaling</div>
                </div>
                <div class="game-card" onclick="window.Engine.openGame('slots')">
                    <i data-lucide="gem" class="game-icon" size="32"></i>
                    <div style="font-weight:bold; color:#fff;">SLOTS</div>
                    <div style="font-size:0.65rem; color:#666;">Jackpot: 50x</div>
                </div>
            </div>

            <div id="game-stage" class="hidden" style="background:#111; border:1px solid #333; padding:15px; border-radius:8px; margin-top:15px;">
                <!-- Dynamic Game Content -->
            </div>
            
            <button class="btn" style="width:100%; margin-top:20px;" onclick="window.Engine.closeGame()">TERUG NAAR MENU</button>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" id="nav-city" onclick="window.UI.nav('city')" data-view="city"><i data-lucide="map" size="20"></i>KAART</button>
        <button class="nav-btn" id="nav-assets" onclick="window.UI.nav('assets')" data-view="assets"><i data-lucide="building-2" size="20"></i>BEZIT</button>
        <button class="nav-btn" id="nav-business" onclick="window.UI.nav('business')" data-view="business"><i data-lucide="package" size="20"></i>HANDEL</button>
        <button class="nav-btn" id="nav-families" onclick="window.UI.nav('families')" data-view="families"><i data-lucide="users" size="20"></i>BAZEN</button>
        <button class="nav-btn" id="nav-ops" onclick="window.UI.nav('ops')" data-view="ops"><i data-lucide="crosshair" size="20"></i>MISSIES</button>
        <button class="nav-btn" id="nav-casino" onclick="window.UI.nav('casino')" data-view="casino"><i data-lucide="dices" size="20"></i>CASINO</button>
        <button class="nav-btn" id="nav-profile" onclick="window.UI.nav('profile')" data-view="profile"><i data-lucide="user" size="20"></i>IK</button>
    </nav>
</div>

<div id="overlay" class="overlay">
    <div class="modal" id="modal-box">
        <div id="m-title" class="modal-title">TITEL</div>
        <div id="m-content" class="modal-text">Inhoud...</div>
        <div id="m-actions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;"></div>
    </div>
</div>

<div id="toast">Melding</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- Data Definitions ---
    const DISTRICTS = {
        'port': { name: 'Port Nero', cost: 12000, income: 450, cx: 100, cy: 90, mods: { drugs: 1.0, weapons: 0.6, tech: 1.2, luxury: 1.3, meds: 0.9 } },
        'crown': { name: 'Crown Heights', cost: 85000, income: 2800, cx: 265, cy: 85, mods: { drugs: 1.8, weapons: 1.5, tech: 1.4, luxury: 2.5, meds: 1.2 } },
        'iron': { name: 'Iron Borough', cost: 25000, income: 900, cx: 215, cy: 200, mods: { drugs: 1.1, weapons: 1.1, tech: 0.7, luxury: 1.2, meds: 1.0 } },
        'low': { name: 'Lowrise', cost: 8000, income: 250, cx: 100, cy: 205, mods: { drugs: 0.5, weapons: 1.3, tech: 1.0, luxury: 0.8, meds: 1.1 } },
        'neon': { name: 'Neon Strip', cost: 45000, income: 1600, cx: 315, cy: 200, mods: { drugs: 1.4, weapons: 1.2, tech: 1.6, luxury: 1.5, meds: 0.8 } }
    };

    const GOODS = [
        { id: 'drugs', name: 'Synthetica', base: 140, icon: 'pipette' },
        { id: 'weapons', name: 'Zware Wapens', base: 1400, icon: 'shield' },
        { id: 'tech', name: 'Zwarte Data', base: 800, icon: 'cpu' },
        { id: 'luxury', name: 'Geroofde Kunst', base: 4500, icon: 'gem' },
        { id: 'meds', name: 'Medische Voorraad', base: 550, icon: 'pill' }
    ];

    const FAMILIES = {
        'cartel': { id: 'cartel', name: 'Rojo Cartel', contact: 'El Serpiente', desc: 'Controleert de haven en drugshandel.', color: '#b91c1c', home: 'port' },
        'syndicate': { id: 'syndicate', name: 'Blue Lotus', contact: 'Mr. Wu', desc: 'Hightech spionage vanuit Crown Heights.', color: '#2563eb', home: 'crown' },
        'bikers': { id: 'bikers', name: 'Iron Skulls', contact: 'Hammer', desc: 'Wapenhandelaren in Iron Borough.', color: '#d97706', home: 'iron' }
    };

    const CONTRACT_TEMPLATES = [
        { name: "Koeriersdienst", risk: 20, heat: 10, rewardBase: 1500, type: 'delivery' },
        { name: "Rivalen Intimideren", risk: 45, heat: 25, rewardBase: 3500, type: 'combat' },
        { name: "Inbraak", risk: 60, heat: 40, rewardBase: 6000, type: 'stealth' },
        { name: "Datadiefstal", risk: 50, heat: 15, rewardBase: 4500, type: 'tech' }
    ];

    const HQ_UPGRADES = [
        { id: 'security', name: 'Versterkte Deuren', cost: 5000, desc: 'Vermindert de kans op aanvallen met 20%.' },
        { id: 'garage', name: 'Grotere Garage', cost: 8000, desc: '+10 Bagage ruimte.' },
        { id: 'server', name: 'Encrypted Server', cost: 12000, desc: 'Sneller Heat verlies (-10 p/d).' },
        { id: 'lab', name: 'Synthetica Lab', cost: 15000, desc: 'Produceer je eigen drugs. Start klein.' }
    ];

    const GEAR = [
        { id: 'glock', type: 'weapon', name: 'Glock 17', cost: 1500, stats: { muscle: 2 }, desc: '+2 Kracht. Betrouwbaar.', reqRep: null },
        { id: 'ak47', type: 'weapon', name: 'AK-47', cost: 4500, stats: { muscle: 5 }, desc: '+5 Kracht. Zwaar geschut.', reqRep: null },
        { id: 'kevlar', type: 'armor', name: 'Kevlar Vest', cost: 2000, stats: { muscle: 1 }, desc: '+1 Kracht. Beschermt tegen kogels.', reqRep: null },
        { id: 'suit', type: 'armor', name: 'Maatpak', cost: 3000, stats: { charm: 3 }, desc: '+3 Charisma. Kleren maken de man.', reqRep: null },
        { id: 'phone', type: 'gadget', name: 'Burner Phone', cost: 800, stats: { brains: 1 }, desc: '+1 Vernuft. Voor snelle deals.', reqRep: null },
        { id: 'jammer', type: 'gadget', name: 'Signal Jammer', cost: 5000, stats: { brains: 4 }, desc: '+4 Vernuft. Blokkeert politiesignalen.', reqRep: null },
        { id: 'goldak', type: 'weapon', name: 'Golden AK', cost: 12000, stats: { muscle: 8, charm: 2 }, desc: 'Cartel Exclusive. Dodelijke bling.', reqRep: { f: 'cartel', val: 50 } },
        { id: 'ghostdeck', type: 'gadget', name: 'Ghost Deck', cost: 15000, stats: { brains: 8 }, desc: 'Syndicate Tech. Hack alles.', reqRep: { f: 'syndicate', val: 50 } },
        { id: 'sawnoff', type: 'weapon', name: 'Sawn-Off', cost: 8000, stats: { muscle: 7 }, desc: 'Biker Favoriet. Korte afstand, enorme schade.', reqRep: { f: 'bikers', val: 50 } }
    ];

    const BUSINESSES = [
        { id: 'bar', name: 'Neon Dive Bar', cost: 15000, income: 300, clean: 150, desc: 'Een kleine bar in de Lowrise. Wast €150/dag.' },
        { id: 'club', name: 'Sapphire Nightclub', cost: 45000, income: 1200, clean: 600, desc: 'Luxe club in de Neon Strip. Wast €600/dag.' },
        { id: 'shipping', name: 'Nero Logistics', cost: 120000, income: 3500, clean: 2000, desc: 'Transportbedrijf in Port Nero. Wast €2000/dag.' },
        { id: 'tech', name: 'Data Haven Ltd', cost: 250000, income: 8000, clean: 5000, desc: 'Serverfarm in Crown Heights. Wast €5000/dag.' }
    ];

    const NEWS_HEADLINES = [
        "Politie verhoogt patrouilles na reeks inbraken.",
        "Grondstoftekort in Crown Heights jaagt prijzen omhoog.",
        "Elena Virelli claimt overwinning in cyberoorlog.",
        "Bounty Hunters gesignaleerd in de havensector.",
        "Bendeoorlog in de Neon Strip drijft vraag naar meds op."
    ];

    const SHADOW_EVENTS = [
        { title: "POLITIE CONTROLE", text: "Een corrupte agent houdt je aan.", options: [
            { text: "KOOP OM (€500)", cost: 500, action: 'bribe' },
            { text: "VLUCHT (50% KANS)", action: 'run' }
        ]},
        { title: "GANG AMBUSH", text: "Rivalen blokkeren de weg.", options: [
            { text: "VECHT", action: 'fight' },
            { text: "BETAAL TOL (€2000)", cost: 2000, action: 'pay' }
        ]},
        { title: "STRAAT DEAL", text: "Een junkie biedt goedkope data aan.", options: [
            { text: "KOOP (€300)", cost: 300, action: 'deal' },
            { text: "NEGEER", action: 'ignore' }
        ]},
        { title: "GEVONDEN BUIT", text: "Je vindt een achtergelaten koffer.", options: [
            { text: "NEEM MEE (+€1000)", action: 'loot' }
        ]}
    ];

    // --- Game Logic ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'noxhaven-saga-v5';
    let state = null;
    let db, auth, user, tradeMode = 'buy';
    let useLocalStorage = false;
    let selectedDistrict = null; 
    let tradeDebounce = false;

    // UI defined FIRST to avoid ReferenceError
    const UI = {
        showDifficulty() { document.getElementById('menu-main').classList.add('hidden'); document.getElementById('menu-difficulty').classList.remove('hidden'); },
        hideDifficulty() { document.getElementById('menu-difficulty').classList.add('hidden'); document.getElementById('menu-main').classList.remove('hidden'); },
        
        showMainMenu() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            this.hideDifficulty(); // Resets the start menu state
        },

        selectDifficulty(d) { Engine.start(d); },
        showTutorial() {
            const html = `
                <div style="text-align:left; font-size:0.75rem; line-height:1.6; color:#ccc;">
                    <div style="margin-bottom:10px;">
                        <strong style="color:var(--gold); display:block; margin-bottom:2px;">1. HANDEL & GELD</strong>
                        Koop goederen laag (groene pijl) en reis naar districten waar de prijs hoog is. Let op de <span style="color:var(--gold); border:1px solid var(--gold); padding:0 3px; font-size:0.6rem; border-radius:3px;">VRAAG</span> tag voor +60% winst.
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:var(--blood); display:block; margin-bottom:2px;">2. CREW & COMBAT</strong>
                        Huur specialisten in het 'Missies' menu. <b>Hackers</b> verlagen Heat, <b>Enforcers</b> doen meer schade, <b>Smokkelaars</b> vergroten je kofferbak en <b>Chauffeurs</b> maken reizen gratis.
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:var(--purple); display:block; margin-bottom:2px;">3. ZWART GELD & DEKMANTELS</strong>
                        Illegale winst (contracten) is 'Zwart Geld'. Koop <b>Bedrijven</b> (zoals een Nachtclub) om dit automatisch wit te wassen. Alleen wit geld kun je uitgeven aan vastgoed.
                    </div>
                    <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px; color:#fff;">
                        <strong style="color:var(--gold)">HET DOEL (KINGPIN):</strong><br>
                        1. Elimineer de 3 Familie Bazen (via Onderwereld).<br>
                        2. Bezit alle 5 Districten.<br>
                        3. Verzamel €5.000.000 schoon vermogen.
                    </div>
                </div>
            `;
            this.modal("HANDBOEK VOOR CRIMINELEN", html);
        },
        hideStartScreen() { 
            document.getElementById('start-screen').classList.add('hidden'); 
            document.getElementById('app').classList.remove('hidden'); 
            this.ensureIcons();
        },
        ensureIcons() {
             if(window.lucide) window.lucide.createIcons();
        },
        nav(view) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                if (b.dataset.view === view) b.classList.add('active');
            });
            this.render();
        },
        setTradeMode(m) { 
            tradeMode = m; 
            document.getElementById('btn-trade-mode-buy').classList.toggle('active-mode', m === 'buy');
            document.getElementById('btn-trade-mode-buy').classList.toggle('btn-gold', m !== 'buy');
            document.getElementById('btn-trade-mode-sell').classList.toggle('active-mode', m === 'sell');
            document.getElementById('btn-trade-mode-sell').classList.toggle('btn-gold', m !== 'sell');
            this.render(); 
        },
        render() {
            if(!state) return;
            document.getElementById('ui-money').innerText = `€${state.money.toLocaleString()}`;
            document.getElementById('ui-casino-money').innerText = state.money.toLocaleString();
            document.getElementById('ui-dirty-money').innerText = `€${state.dirtyMoney.toLocaleString()}`;
            document.getElementById('ui-rep').innerText = state.rep;
            document.getElementById('ui-heat').innerText = `${state.heat}%`;
            document.getElementById('ui-hp').innerText = state.hp;
            document.getElementById('ui-date').innerText = `DAG ${state.day}`;
            document.getElementById('ui-debt').innerText = state.debt.toLocaleString();
            document.getElementById('ui-police-rel').innerText = state.policeRel;
            
            const totalCharm = Engine.getPlayerStat('charm');
            const bribeCost = Math.max(1000, 3500 - (totalCharm * 150));
            document.getElementById('ui-bribe-cost').innerText = `€${bribeCost.toLocaleString()}`;

            const rankNames = ['Loopjongen', 'Associate', 'Soldier', 'Capo', 'Underboss', 'Don', 'Kingpin'];
            document.getElementById('ui-rank').innerText = rankNames[Math.min(rankNames.length-1, Math.floor(state.rep/300))];
            
            if (state.debt > 75000) document.getElementById('ui-debt').style.color = 'var(--blood)';
            else document.getElementById('ui-debt').style.color = 'white';

            this.renderMap();
            this.renderMarket();
            this.renderFamilies();
            this.renderCrew();
            this.renderContracts();
            this.renderProfile();
            this.renderAssets();
            document.getElementById('ui-news').innerText = state.currentNews;
            
            this.ensureIcons();
        },

        renderAssets() {
            // Lab Render
            const labEl = document.getElementById('lab-status');
            const labCtl = document.getElementById('lab-controls');
            if (state.hqUpgrades.includes('lab')) {
                labEl.innerHTML = `<span style="color:var(--green)">ACTIEF</span> | Voorraad Chemicaliën: ${state.lab.chemicals}`;
                labCtl.innerHTML = `<button class="btn btn-sm btn-gold" onclick="window.Engine.buyPrecursors()">KOOP 10 CHEM (€500)</button><div style="font-size:0.6rem; color:#666; margin-top:5px;">Produceert max 20 drugs/nacht als er voorraad is.</div>`;
            } else {
                labEl.innerText = "Niet in bezit (Koop bij Onderwereld)";
                labCtl.innerHTML = '';
            }

            const owned = state.ownedBusinesses || [];
            document.getElementById('business-list').innerHTML = BUSINESSES.map(b => {
                const isOwned = owned.includes(b.id);
                const btnClass = isOwned ? 'btn-gold' : (state.money >= b.cost ? 'btn-action' : 'btn');
                const btnText = isOwned ? 'IN BEZIT' : `KOOP (€${b.cost.toLocaleString()})`;
                const btnAction = isOwned ? '' : `onclick="window.Engine.buyBusiness('${b.id}')"`;
                const disabled = isOwned ? 'disabled' : '';
                
                return `
                <div class="card" style="border-left: 3px solid ${isOwned ? 'var(--gold)' : '#333'}">
                    <div class="card-row">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="background:#222; padding:8px; border-radius:6px;"><i data-lucide="building" size="16" color="${isOwned ? 'var(--gold)' : '#666'}"></i></div>
                            <div>
                                <div class="card-title">${b.name}</div>
                                <div class="card-sub">${b.desc}</div>
                                <div class="card-sub" style="color:var(--green)">+€${b.income}/dag | Wast €${b.clean}</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn ${btnClass}" style="width:100%; margin-top:8px;" ${disabled} ${btnAction}>${btnText}</button>
                </div>`;
            }).join('');
        },

        renderProfile() {
            if (!state.player) return;
            document.getElementById('ui-lvl').innerText = state.player.level;
            document.getElementById('ui-sp').innerText = state.player.skillPoints;
            document.getElementById('ui-xp').innerText = state.player.xp;
            document.getElementById('ui-xp-next').innerText = state.player.nextXp;
            document.getElementById('ui-xp-bar').style.width = `${Math.min(100, (state.player.xp / state.player.nextXp) * 100)}%`;

            const stats = [
                { id: 'muscle', label: 'Kracht', icon: 'swords' },
                { id: 'brains', label: 'Vernuft', icon: 'brain' },
                { id: 'charm', label: 'Charisma', icon: 'gem' }
            ];

            document.getElementById('stats-list').innerHTML = stats.map(s => {
                const base = state.player.stats[s.id];
                const total = Engine.getPlayerStat(s.id);
                const bonus = total - base;
                const bonusText = bonus > 0 ? `<span style="color:var(--gold)">+${bonus}</span>` : '';
                const btn = state.player.skillPoints > 0 ? `<button class="stat-btn" onclick="window.Engine.upgradeStat('${s.id}')">+</button>` : '';
                return `
                <div class="stat-row">
                    <div style="width:70px; display:flex; gap:6px; align-items:center;"><i data-lucide="${s.icon}" size="14"></i> ${s.label}</div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${Math.min(100, (total/15)*100)}%; background:var(--gold);"></div></div>
                    <div class="stat-val">${base}${bonusText}</div>
                    <div style="width:25px;">${btn}</div>
                </div>`;
            }).join('');

            ['weapon', 'armor', 'gadget'].forEach(slot => {
                const el = document.getElementById(`slot-${slot}`);
                const equippedId = state.player.loadout[slot];
                if (equippedId) {
                    const item = GEAR.find(g => g.id === equippedId);
                    el.classList.add('filled');
                    el.innerHTML = `<i data-lucide="${this.getIconForSlot(slot)}" class="equip-icon"></i><div style="font-weight:bold;">${item.name}</div><div class="equip-label">Klik om uit te doen</div>`;
                } else {
                    el.classList.remove('filled');
                    el.innerHTML = `<i data-lucide="${this.getIconForSlot(slot)}" class="equip-icon"></i><span class="equip-label">${slot}</span>`;
                }
            });

            const owned = state.ownedGear || [];
            const inventoryItems = owned.filter(id => !Object.values(state.player.loadout).includes(id));
            
            if (inventoryItems.length === 0) {
                document.getElementById('gear-inventory-list').innerHTML = '<div style="color:#444; font-size:0.7rem; font-style:italic; padding:10px;">Kluis is leeg. Koop gear op de Zwarte Markt of bij Facties.</div>';
            } else {
                document.getElementById('gear-inventory-list').innerHTML = inventoryItems.map(id => {
                    const item = GEAR.find(g => g.id === id);
                    return `<div class="card"><div class="card-row"><div><div class="card-title">${item.name}</div><div class="card-sub">${item.desc}</div></div><button class="btn btn-sm btn-gold" onclick="window.Engine.equip('${item.id}')">DRAAG</button></div></div>`;
                }).join('');
            }
        },

        getIconForSlot(slot) {
            if (slot === 'weapon') return 'sword';
            if (slot === 'armor') return 'shield';
            return 'smartphone';
        },

        renderMap() {
            document.querySelectorAll('.map-district').forEach(p => {
                const id = p.id.replace('map-', '');
                p.classList.remove('selected', 'owned');
                if (id === selectedDistrict) p.classList.add('selected');
                if (state.ownedDistricts.includes(id)) p.classList.add('owned');
                const iconEl = document.getElementById(`icon-${id}`);
                let iconText = "";
                if (state.districtDemands[id]) iconText = "$";
                if (state.ownedDistricts.includes(id)) iconText = "♛";
                iconEl.textContent = iconText;
            });

            const markerGroup = document.getElementById('player-marker');
            const d = DISTRICTS[state.loc];
            if(d) markerGroup.setAttribute('transform', `translate(${d.cx}, ${d.cy})`);

            const sel = DISTRICTS[selectedDistrict];
            document.getElementById('dist-name').innerText = sel ? sel.name : "Selecteer District";
            
            const demandGood = state.districtDemands[selectedDistrict];
            const demandName = demandGood ? GOODS.find(g => g.id === demandGood).name : "Geen";
            document.getElementById('dist-bonus').innerHTML = demandGood 
                ? `<span style="color:var(--gold)">Hoge vraag: ${demandName} (+60%)</span>`
                : `<span style="color:var(--text-muted)">Geen actieve vraag</span>`;

            const btn = document.getElementById('btn-action-district');
            if (state.loc === selectedDistrict) {
                if (state.ownedDistricts.includes(selectedDistrict)) {
                    btn.innerText = "JOUW TERRITORIUM";
                    btn.disabled = true;
                    btn.classList.remove('btn-gold', 'btn-action');
                } else {
                    btn.innerText = `OVERNEMEN (€${sel.cost.toLocaleString()})`;
                    btn.disabled = state.money < sel.cost;
                    btn.classList.add('btn-gold');
                    btn.classList.remove('btn-action');
                }
            } else {
                const hasChauffeur = state.crew.some(c => c.role === 'Chauffeur');
                const isOwned = state.ownedDistricts.includes(selectedDistrict);
                const cost = (hasChauffeur || isOwned) ? 0 : 50;
                btn.innerText = cost > 0 ? `REIS HIERHEEN (€${cost})` : `REIS (GRATIS)`;
                btn.disabled = state.money < cost;
                btn.classList.add('btn-action'); 
                btn.classList.remove('btn-gold');
            }
            btn.onclick = () => window.Engine.performDistrictAction();
        },

        renderMarket() {
            document.getElementById('ui-loc-market').innerText = DISTRICTS[state.loc].name;
            const alertBox = document.getElementById('ui-market-alert');
            
            const isRemote = state.loc !== selectedDistrict && selectedDistrict !== null;
            if (isRemote) alertBox.style.display = 'block';
            else alertBox.style.display = 'none';

            const invCount = Object.values(state.inventory).reduce((a, b) => a + (b || 0), 0);
            document.getElementById('ui-inv-count').innerText = invCount;
            document.getElementById('ui-inv-max').innerText = state.maxInv;
            
            // Visual indicator for full inventory
            const fullIndicator = document.getElementById('ui-inv-full');
            if (invCount >= state.maxInv) {
                fullIndicator.style.display = 'inline';
            } else {
                fullIndicator.style.display = 'none';
            }
            
            const totalCharm = Engine.getPlayerStat('charm');
            const charmBonus = Math.floor(((totalCharm * 0.02) + (state.rep / 5000)) * 100);
            document.getElementById('ui-trade-bonus').innerText = `${charmBonus}% (Charisma)`;
            
            document.getElementById('shop-gear-list').innerHTML = GEAR.map(g => {
                const owned = state.ownedGear && state.ownedGear.includes(g.id);
                if (owned) return ''; 
                if (g.reqRep) {
                     const currentRep = state.familyRel[g.reqRep.f] || 0;
                     if (currentRep < g.reqRep.val) return '';
                }
                return `<div class="card"><div class="card-row"><div><div class="card-title">${g.name}</div><div class="card-sub">${g.desc}</div></div><button class="btn btn-sm btn-gold" onclick="window.Engine.buyGear('${g.id}')">€${g.cost}</button></div></div>`;
            }).join('');

            const prices = state.prices[state.loc] || {};
            const demand = state.districtDemands[state.loc];
            
            document.getElementById('market-list').innerHTML = GOODS.map(g => {
                const trend = state.priceTrends[g.id] === 'up' ? 'trend-up' : 'trend-down';
                const basePrice = prices[g.id] || 0;
                let displayPrice = basePrice;
                let priceLabel = "Inkoop";
                let btnDisabled = false;
                
                if (tradeMode === 'sell') {
                     const totalCharm = Engine.getPlayerStat('charm');
                     const charmBonus = (totalCharm * 0.02) + (state.rep / 5000);
                     displayPrice = Math.floor(basePrice * 0.85 * (1 + charmBonus));
                     priceLabel = "Verkoop";
                     
                     // Profit Calculation
                     const avgCost = state.inventoryCosts[g.id] || 0;
                     const profit = displayPrice - avgCost;
                     const profitClass = profit >= 0 ? 'var(--green)' : 'var(--blood)';
                     const profitSign = profit >= 0 ? '+' : '';
                     const profitStr = `<span style="color:${profitClass}; font-weight:bold; margin-left:5px;">(${profitSign}€${Math.floor(profit)})</span>`;
                     
                     if ((state.inventory[g.id] || 0) > 0) {
                        priceLabel += ` ${profitStr}`; 
                     }

                     if ((state.inventory[g.id] || 0) <= 0) btnDisabled = true;
                } else {
                     if (isRemote) btnDisabled = true;
                }

                return `<div class="card"><div class="market-item-grid"><div style="display:flex; align-items:center; gap:10px;"><div style="background:#222; padding:8px; border-radius:8px; color:var(--gold)"><i data-lucide="${g.icon}"></i></div><div><div class="card-title">${g.name} <span class="price-trend ${trend}">${state.priceTrends[g.id] === 'up' ? '↑' : '↓'}</span> ${demand === g.id ? '<span class="demand-tag">VRAAG</span>' : ''}</div><div class="card-sub">${priceLabel}: €${displayPrice} | Bezit: ${state.inventory[g.id] || 0}</div></div></div><button class="btn btn-sm btn-gold" ${btnDisabled ? 'disabled style="opacity:0.3"' : ''} onclick="window.Engine.trade('${g.id}')">${tradeMode === 'buy' ? 'KOOP' : 'VERKOOP'}</button></div></div>`;
            }).join('');
        },

        renderFamilies() {
            document.getElementById('contact-list').innerHTML = Object.keys(FAMILIES).map(f => {
                const fam = FAMILIES[f];
                const rel = state.familyRel[f] || 0;
                const dead = state.leadersDefeated.includes(f);
                const statusColor = dead ? '#444' : fam.color;
                const statusText = dead ? 'LEIDER DOOD' : `Relatie: ${rel}/100`;
                
                return `
                <div class="card" style="border-left: 3px solid ${statusColor}; ${dead ? 'opacity:0.6' : ''}">
                    <div class="card-row">
                        <div>
                            <div class="card-title">${fam.name} <span class="faction-tag" style="background:${fam.color}">${f.toUpperCase()}</span></div>
                            <div class="card-sub">${fam.contact} | ${fam.desc}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="tag" style="font-weight:bold;">${statusText}</div>
                            ${!dead && rel < -20 ? `<button class="btn btn-sm btn-danger" style="margin-top:5px;" onclick="window.UI.showAssassinate('${f}')">DOOD LEIDER</button>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('hq-list').innerHTML = HQ_UPGRADES.map(u => {
                const owned = state.hqUpgrades.includes(u.id);
                return `<div class="card"><div class="card-row"><div><div class="card-title">${u.name}</div><div class="card-sub">${u.desc}</div></div><button class="btn btn-sm ${owned ? '' : 'btn-gold'}" ${owned ? 'disabled' : ''} onclick="window.Engine.buyUpgrade('${u.id}')">${owned ? 'BEZIT' : '€'+u.cost}</button></div></div>`;
            }).join('');
        },

        renderCrew() {
            const comments = ["Klaar voor actie.", "Alles rustig.", "Ik heb een slecht gevoel.", "Waar is het geld?", "Tijd om te knallen.", "Rustig aan, baas."];
            if (!state.crew.length) {
                document.getElementById('crew-list').innerHTML = `<div style="text-align:center; color:#666; padding:10px;">Geen crew. Huur specialisten.</div>`;
                return;
            }

            document.getElementById('crew-list').innerHTML = state.crew.map((c, i) => {
                const healthColor = c.hp < 30 ? 'var(--blood)' : '#fff';
                const healthWarning = c.hp < 30 ? '⚠️' : '';
                return `
                <div class="card">
                    <div class="card-row">
                        <div>
                            <div class="card-title">${c.name}</div>
                            <div class="card-sub">${c.role} Lvl ${c.level} | <i>"${comments[Math.floor(Math.random()*comments.length)]}"</i></div>
                        </div>
                        <div style="text-align:right">
                            <div class="tag" style="color:${healthColor}">${healthWarning} ${c.hp} HP</div>
                            ${c.hp < 100 ? `<button class="btn btn-sm btn-heal" style="margin-top:4px;" onclick="window.Engine.healCrew(${i})">GENEES €${(100-c.hp)*5}</button>` : ''}
                        </div>
                    </div>
                    <div class="progress-container"><div class="progress-fill" style="width:${c.xp}%; background:var(--gold);"></div></div>
                </div>`;
            }).join('');
        },

        renderContracts() {
            if (state.activeContracts.length === 0) {
                 document.getElementById('crimes-list').innerHTML = `<div style="text-align:center; padding:20px; color:#666;">Geen contracten beschikbaar. Wacht tot morgen.</div>`;
                 return;
            }

            document.getElementById('crimes-list').innerHTML = state.activeContracts.map(c => {
                const employer = FAMILIES[c.employer];
                const target = FAMILIES[c.target];
                return `
                <div class="card">
                    <div class="card-row">
                        <div>
                            <div class="card-title"><span style="color:${employer.color}">■</span> ${c.name}</div>
                            <div class="card-sub">
                                Voor: <b>${employer.name}</b> | Tegen: <b>${target.name}</b><br>
                                Beloning: €${c.reward} | Risico: ${c.risk}%
                            </div>
                        </div>
                        <button class="btn btn-sm btn-action" onclick="window.UI.showContractSelect('${c.id}')">ACCEPT</button>
                    </div>
                </div>`;
            }).join('');
        },

        showContractSelect(cid) {
            if (state.crew.length === 0) return this.toast("Huur eerst crewleden.", true);
            let html = '<p style="margin-bottom:15px; font-size:0.8rem;">Wie voert het contract uit?</p>';
            state.crew.forEach((c, i) => {
                html += `<button class="btn btn-choice" onclick="window.Engine.acceptContract('${cid}', ${i})">${c.name} (${c.role})</button>`;
            });
            this.modal("KIES UITVOERDER", html, '<button class="btn" onclick="window.UI.closeModal()">ANNULEREN</button>');
        },

        showAssassinate(fid) {
            if (state.crew.length === 0) return this.toast("Je hebt een team nodig.", true);
            const fam = FAMILIES[fid];
            const html = `<p>Je staat op het punt <b>${fam.contact}</b> aan te vallen. Dit is een zelfmoordmissie als je niet voorbereid bent.</p><p>Risico: EXTREEM</p>`;
            let actions = '';
            state.crew.forEach((c, i) => {
                actions += `<button class="btn btn-choice" onclick="window.Engine.assassinateLeader('${fid}', ${i})">Stuur ${c.name}</button>`;
            });
            actions += `<button class="btn" onclick="window.UI.closeModal()">ANNULEREN</button>`;
            this.modal("LEADER ASSASSINATION", html, actions);
        },

        modal(t, m, a = null) {
            document.getElementById('m-title').innerText = t;
            document.getElementById('m-content').innerHTML = m;
            document.getElementById('m-actions').innerHTML = a || '<button class="btn btn-action" onclick="window.UI.closeModal()">BEGREPEN</button>';
            document.getElementById('overlay').style.display = 'flex';
            if(window.lucide) window.lucide.createIcons();
        },
        closeModal() { document.getElementById('overlay').style.display = 'none'; },
        
        toast(m, isNegative = false) { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            if(isNegative) t.classList.add('toast-red');
            else t.classList.remove('toast-red');
            t.style.display = 'block'; 
            setTimeout(() => t.style.display = 'none', 3000); 
        }
    };

    const Engine = {
        async init() {
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config) throw new Error("Local Mode");
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (u) => {
                    user = u;
                    if (user) await this.load();
                });
            } catch (e) {
                console.log("Overschakelen naar offline modus:", e);
                useLocalStorage = true;
                this.load();
            }
        },

        async load() {
            let loadedState = null;
            if (useLocalStorage) {
                const localData = localStorage.getItem('noxhaven_save');
                if (localData) {
                    try {
                        loadedState = JSON.parse(localData);
                    } catch (e) {
                        console.error("Corrupt save data", e);
                        UI.toast("Save corrupt. Reset aanbevolen.", true);
                    }
                }
            } else if (user && db) {
                try {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'save', 'game'));
                    if (snap.exists()) loadedState = snap.data();
                } catch(e) { console.error("Load error, falling back to local", e); }
            }

            if (loadedState) {
                state = loadedState;
                this.checkSaveIntegrity(); 
                this.recalcStats(); 
                UI.hideStartScreen();
                this.generatePrices(false); 
                selectedDistrict = state.loc;
                
                if (state.activeCombat) {
                    window.Engine.combatState = state.activeCombat;
                    this.restoreCombatUI();
                }
                UI.render();
            }
        },

        checkSaveIntegrity() {
            if (!state.version || state.version < 6.4) state.version = 6.4; 
            if (!state.player) state.player = { level: 1, xp: 0, nextXp: 100, skillPoints: 0, stats: { muscle: 1, brains: 1, charm: 1 }, loadout: { weapon: null, armor: null, gadget: null } };
            if (!state.ownedGear) state.ownedGear = [];
            if (!state.ownedBusinesses) state.ownedBusinesses = [];
            if (!state.prices) state.prices = {};
            if (!state.districtDemands) state.districtDemands = {};
            if (!state.priceTrends) state.priceTrends = {};
            if (state.activeCombat === undefined) state.activeCombat = null;
            if (state.maxInv === undefined) state.maxInv = 15;
            
            if (!state.activeContracts) state.activeContracts = [];
            if (!state.lab) state.lab = { chemicals: 0 };
            if (!state.leadersDefeated) state.leadersDefeated = [];
            
            // NEW: Initialize Average Costs
            if (!state.inventoryCosts) state.inventoryCosts = {};
            // Backfill costs for existing items to prevent crazy profit numbers
            Object.keys(state.inventory).forEach(key => {
                if (state.inventory[key] > 0 && !state.inventoryCosts[key]) {
                    const good = GOODS.find(g => g.id === key);
                    state.inventoryCosts[key] = good ? good.base : 0;
                }
            });
            
            if (state.player.nextXp > 50000) state.player.nextXp = 5000;
            
            if (state.activeContracts.length === 0) this.generateContracts();
        },

        recalcStats() {
            let inv = 15; 
            if (state.hqUpgrades.includes('garage')) inv += 10;
            const smugglers = state.crew.filter(c => c.role === 'Smokkelaar').length;
            inv += (smugglers * 5);
            state.maxInv = inv;
        },

        async save() {
            if (!state) return;
            state.version = 6.4; 
            try {
                if (useLocalStorage) {
                    localStorage.setItem('noxhaven_save', JSON.stringify(state));
                } else if (user && db) {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'save', 'game'), state);
                }
            } catch (e) {
                console.error("Save failed", e);
                localStorage.setItem('noxhaven_save', JSON.stringify(state)); // Always backup locally
            }
        },
        
        exportSave() {
            if(!state) return UI.toast("Geen save data.");
            const dataStr = JSON.stringify(state);
            const input = document.createElement('input');
            input.value = dataStr;
            document.body.appendChild(input);
            input.select();
            
            // Try modern api then fallback
            if (navigator.clipboard) {
                navigator.clipboard.writeText(dataStr).then(() => {
                    UI.toast("Save gekopieerd naar klembord!");
                }).catch(() => {
                    document.execCommand('copy');
                    UI.toast("Save gekopieerd (Fallback).");
                });
            } else {
                document.execCommand('copy');
                UI.toast("Save gekopieerd (Legacy).");
            }
            document.body.removeChild(input);
        },

        async reset() {
            if (confirm("Weet je zeker dat je alles wilt wissen?")) {
                localStorage.removeItem('noxhaven_save');
                if (user && db) {
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'save', 'game')); } catch(e){}
                }
                state = null;
                location.reload();
            }
        },
        
        async quitToMenu() {
            await this.save();
            UI.showMainMenu();
        },

        start(diff) {
            let money = 5000, debt = 12000, heat = 0;
            if (diff === 'easy') { money = 12000; debt = 0; }
            if (diff === 'hard') { money = 1500; debt = 25000; heat = 15; }

            state = {
                version: 6.4,
                day: 1, money: money, dirtyMoney: 0, rep: 0, hp: 100, heat: heat, debt: debt,
                loc: 'low', maxInv: 15, inventory: { drugs: 0, weapons: 0, tech: 0, luxury: 0, meds: 0 },
                inventoryCosts: {}, // Track avg costs
                crew: [], ownedDistricts: [], hqUpgrades: [], ownedGear: [], ownedBusinesses: [], policeRel: 20, 
                familyRel: { cartel: 0, syndicate: 0, bikers: 0 },
                activeContracts: [],
                lab: { chemicals: 0 },
                leadersDefeated: [],
                prices: {}, priceTrends: {}, districtDemands: {},
                currentNews: NEWS_HEADLINES[0], difficulty: diff,
                activeCombat: null,
                player: {
                    level: 1, xp: 0, nextXp: 100, skillPoints: 0,
                    stats: { muscle: 1, brains: 1, charm: 1 },
                    loadout: { weapon: null, armor: null, gadget: null }
                }
            };
            
            this.generateContracts();
            UI.hideStartScreen();
            this.generatePrices(true);
            selectedDistrict = state.loc;
            UI.render();
            this.save();
        },

        // --- Casino Logic ---
        openGame(game) {
            const stage = document.getElementById('game-stage');
            document.getElementById('casino-menu').classList.add('hidden');
            stage.classList.remove('hidden');
            stage.innerHTML = ''; // Clear

            if(game === 'blackjack') this.startBlackjackUI(stage);
            if(game === 'roulette') this.startRouletteUI(stage);
            if(game === 'slots') this.startSlotsUI(stage);
        },

        closeGame() {
            document.getElementById('game-stage').classList.add('hidden');
            document.getElementById('casino-menu').classList.remove('hidden');
        },

        // --- Blackjack ---
        blackjackDeck: [],
        blackjackHand: [],
        dealerHand: [],
        blackjackBet: 0,
        
        startBlackjackUI(stage) {
            stage.innerHTML = `
                <div style="text-align:center; margin-bottom:15px;">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--gold)">BLACKJACK</div>
                    <div style="font-size:0.7rem; color:#666;">Dealer past op 17</div>
                </div>
                <div id="bj-table">
                    <div style="margin-bottom:10px;">DEALER: <span id="bj-dealer-score">?</span></div>
                    <div id="bj-dealer-cards" style="min-height:70px; margin-bottom:15px;"></div>
                    <div style="margin-bottom:10px;">JOUW HAND: <span id="bj-player-score">0</span></div>
                    <div id="bj-player-cards" style="min-height:70px;"></div>
                </div>
                <div id="bj-controls" style="margin-top:20px; display:grid; gap:10px;">
                    <input type="number" id="bj-bet" value="100" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; text-align:center;">
                    <button class="btn btn-gold" onclick="window.Engine.dealBlackjack()">DEAL</button>
                </div>
                <div id="bj-actions" class="hidden" style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn btn-action" onclick="window.Engine.bjHit()">HIT</button>
                    <button class="btn" onclick="window.Engine.bjStand()">STAND</button>
                </div>
                <div id="bj-result" style="margin-top:15px; text-align:center; font-weight:bold; height:20px;"></div>
            `;
        },

        createDeck() {
            const suits = ['h','d','c','s'];
            const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            let deck = [];
            for(let s of suits) { for(let r of ranks) { deck.push(r); } }
            return deck.sort(() => Math.random() - 0.5);
        },

        dealBlackjack() {
            const betInput = document.getElementById('bj-bet');
            const bet = parseInt(betInput.value);
            if(bet > state.money) return UI.toast("Niet genoeg geld!", true);
            if(bet < 10) return UI.toast("Minimale inzet €10", true);

            state.money -= bet;
            this.blackjackBet = bet;
            this.blackjackDeck = this.createDeck();
            this.blackjackHand = [this.blackjackDeck.pop(), this.blackjackDeck.pop()];
            this.dealerHand = [this.blackjackDeck.pop(), this.blackjackDeck.pop()];
            
            document.getElementById('bj-controls').classList.add('hidden');
            document.getElementById('bj-actions').classList.remove('hidden');
            document.getElementById('bj-result').innerText = '';
            
            this.updateBlackjackUI(false);
            UI.render(); // update money display
            
            // Check instant blackjack
            if(this.getScore(this.blackjackHand) === 21) {
                this.bjStand();
            }
        },

        bjHit() {
            this.blackjackHand.push(this.blackjackDeck.pop());
            this.updateBlackjackUI(false);
            if(this.getScore(this.blackjackHand) > 21) {
                this.endBlackjack(false, "BUST! Je hebt meer dan 21.");
            }
        },

        bjStand() {
            let dealerScore = this.getScore(this.dealerHand);
            while(dealerScore < 17) {
                this.dealerHand.push(this.blackjackDeck.pop());
                dealerScore = this.getScore(this.dealerHand);
            }
            this.updateBlackjackUI(true);
            
            const playerScore = this.getScore(this.blackjackHand);
            
            if(dealerScore > 21) {
                this.endBlackjack(true, "Dealer Busted! Jij wint!");
            } else if (playerScore > dealerScore) {
                this.endBlackjack(true, "Jij wint!");
            } else if (playerScore === dealerScore) {
                state.money += this.blackjackBet; // Push
                this.endBlackjack(null, "Gelijkspel (Push).");
            } else {
                this.endBlackjack(false, "Dealer wint.");
            }
        },

        endBlackjack(win, msg) {
            document.getElementById('bj-actions').classList.add('hidden');
            document.getElementById('bj-controls').classList.remove('hidden');
            
            const el = document.getElementById('bj-result');
            el.innerText = msg;
            
            if(win === true) {
                el.style.color = "var(--green)";
                const isBj = this.getScore(this.blackjackHand) === 21 && this.blackjackHand.length === 2;
                const winAmount = Math.floor(this.blackjackBet * (isBj ? 2.5 : 2));
                state.money += winAmount;
                if(winAmount > 5000) UI.toast("BIG WIN!", false);
            } else if (win === false) {
                el.style.color = "var(--blood)";
            } else {
                el.style.color = "white";
            }
            UI.render();
            this.save();
        },

        getScore(hand) {
            let score = 0;
            let aces = 0;
            for(let card of hand) {
                if(card === 'A') { aces++; score += 11; }
                else if (['K','Q','J'].includes(card)) { score += 10; }
                else { score += parseInt(card); }
            }
            while(score > 21 && aces > 0) { score -= 10; aces--; }
            return score;
        },

        updateBlackjackUI(showDealer) {
            const renderCard = (c, hidden=false) => {
                if(hidden) return `<div class="playing-card back"></div>`;
                const isRed = ['♥','♦'].includes(c) || false; // Simplified, assuming suit not tracked for color logic in simplified array
                // Making visual logic simple based on random chance for color since suit is stripped in logic above
                // To do it right, logic needs update. For now, random red/black visual or just black text.
                return `<div class="playing-card black">${c}</div>`;
            };

            document.getElementById('bj-player-cards').innerHTML = this.blackjackHand.map(c => renderCard(c)).join('');
            document.getElementById('bj-player-score').innerText = this.getScore(this.blackjackHand);

            if(showDealer) {
                document.getElementById('bj-dealer-cards').innerHTML = this.dealerHand.map(c => renderCard(c)).join('');
                document.getElementById('bj-dealer-score').innerText = this.getScore(this.dealerHand);
            } else {
                document.getElementById('bj-dealer-cards').innerHTML = renderCard(this.dealerHand[0]) + renderCard(null, true);
                document.getElementById('bj-dealer-score').innerText = "?";
            }
        },

        // --- Roulette ---
        startRouletteUI(stage) {
            stage.innerHTML = `
                <div style="text-align:center; margin-bottom:15px;">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--gold)">ROULETTE</div>
                </div>
                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                    <div id="roulette-wheel" style="width:80px; height:80px; border-radius:50%; border:4px solid #333; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; background:#000;">
                        ?
                    </div>
                </div>
                <input type="number" id="r-bet" value="100" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; text-align:center; margin-bottom:10px;">
                <div style="display:flex; gap:5px;">
                    <button class="roulette-btn r-red" onclick="window.Engine.spinRoulette('red')">ROOD (x2)</button>
                    <button class="roulette-btn r-green" onclick="window.Engine.spinRoulette('green')">0 (x14)</button>
                    <button class="roulette-btn r-black" onclick="window.Engine.spinRoulette('black')">ZWART (x2)</button>
                </div>
                <div id="r-result" style="margin-top:15px; text-align:center; font-weight:bold; height:20px;"></div>
            `;
        },

        spinRoulette(choice) {
            const betInput = document.getElementById('r-bet');
            const bet = parseInt(betInput.value);
            if(bet > state.money) return UI.toast("Niet genoeg geld!", true);
            state.money -= bet;
            UI.render();

            const wheel = document.getElementById('roulette-wheel');
            let counter = 0;
            const interval = setInterval(() => {
                const num = Math.floor(Math.random() * 37);
                let color = 'black';
                if(num === 0) color = 'green';
                else if ([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(num)) color = 'red'; // Standard layout approximation
                
                wheel.style.backgroundColor = color === 'red' ? 'var(--blood)' : (color === 'green' ? 'var(--green)' : '#111');
                wheel.innerText = num;
                counter++;
                if(counter > 20) {
                    clearInterval(interval);
                    this.resolveRoulette(num, color, choice, bet);
                }
            }, 50);
        },

        resolveRoulette(num, color, choice, bet) {
            let won = false;
            let multiplier = 0;

            if (choice === 'red' && color === 'red') { won = true; multiplier = 2; }
            else if (choice === 'black' && color === 'black') { won = true; multiplier = 2; }
            else if (choice === 'green' && num === 0) { won = true; multiplier = 14; }

            const resEl = document.getElementById('r-result');
            if (won) {
                const winAmt = bet * multiplier;
                state.money += winAmt;
                resEl.innerText = `GEWONNEN! +€${winAmt}`;
                resEl.style.color = "var(--green)";
            } else {
                resEl.innerText = "VERLOREN";
                resEl.style.color = "var(--blood)";
            }
            UI.render();
            this.save();
        },

        // --- Slots ---
        startSlotsUI(stage) {
            stage.innerHTML = `
                <div style="text-align:center; margin-bottom:15px;">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--gold)">NEON SLOTS</div>
                </div>
                <div style="text-align:center; margin-bottom:20px;">
                    <div class="slot-reel" id="s1">🍒</div>
                    <div class="slot-reel" id="s2">🍒</div>
                    <div class="slot-reel" id="s3">🍒</div>
                </div>
                <input type="number" id="s-bet" value="50" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; text-align:center; margin-bottom:10px;">
                <button class="btn btn-gold" style="width:100%" onclick="window.Engine.spinSlots()">DRAAIEN</button>
                <div id="s-result" style="margin-top:15px; text-align:center; font-weight:bold; height:20px;"></div>
            `;
        },

        spinSlots() {
            const betInput = document.getElementById('s-bet');
            const bet = parseInt(betInput.value);
            if(bet > state.money) return UI.toast("Niet genoeg geld!", true);
            state.money -= bet;
            UI.render();

            const symbols = ['🍒','🍒','🍒','🍋','🍋','🍇','💎','7️⃣']; // Weighted array
            const reels = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3')];
            let results = [];

            let spins = 0;
            const interval = setInterval(() => {
                results = [];
                reels.forEach(r => {
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    r.innerText = sym;
                    results.push(sym);
                });
                spins++;
                if(spins > 15) {
                    clearInterval(interval);
                    this.resolveSlots(results, bet);
                }
            }, 100);
        },

        resolveSlots(res, bet) {
            const [a, b, c] = res;
            let win = 0;
            
            if (a === b && b === c) {
                if(a === '7️⃣') win = bet * 50;
                else if (a === '💎') win = bet * 30;
                else win = bet * 10;
            } else if (a === b || b === c || a === c) {
                win = Math.floor(bet * 1.5); // Small win pair
            }

            const el = document.getElementById('s-result');
            if (win > 0) {
                state.money += win;
                el.innerText = `WINNAAR! +€${win}`;
                el.style.color = "var(--green)";
            } else {
                el.innerText = "Helaas...";
                el.style.color = "#666";
            }
            UI.render();
            this.save();
        },

        generatePrices(force = false) {
            if (!force && state.prices && Object.keys(state.prices).length > 0) return;
            state.prices = {};
            state.districtDemands = {}; 
            Object.keys(DISTRICTS).forEach(id => {
                state.prices[id] = {};
                state.districtDemands[id] = Math.random() > 0.8 ? GOODS[Math.floor(Math.random()*GOODS.length)].id : null;
                GOODS.forEach(g => {
                    const volatility = 0.6 + (Math.random() * 0.8);
                    const demandMod = (state.districtDemands[id] === g.id) ? 1.6 : 1.0;
                    const newPrice = Math.floor(g.base * volatility * DISTRICTS[id].mods[g.id] * demandMod);
                    state.prices[id][g.id] = newPrice;
                    state.priceTrends[g.id] = Math.random() > 0.5 ? 'up' : 'down';
                });
            });
        },
        
        generateContracts() {
            state.activeContracts = [];
            for(let i=0; i<3; i++) {
                const template = CONTRACT_TEMPLATES[Math.floor(Math.random() * CONTRACT_TEMPLATES.length)];
                const factionKeys = Object.keys(FAMILIES);
                const employer = factionKeys[Math.floor(Math.random() * factionKeys.length)];
                let target = factionKeys[Math.floor(Math.random() * factionKeys.length)];
                while(target === employer) target = factionKeys[Math.floor(Math.random() * factionKeys.length)];
                
                let risk = Math.min(90, template.risk + (state.day / 2));
                
                state.activeContracts.push({
                    id: Date.now() + i,
                    name: template.name,
                    type: template.type,
                    employer: employer,
                    target: target,
                    risk: Math.floor(risk),
                    heat: template.heat,
                    reward: Math.floor(template.rewardBase * (1 + (state.day * 0.05))),
                    xp: 35 + (state.day * 2)
                });
            }
        },

        async endTurn() {
            if (state.debt > 250000) { 
                const gameOverHtml = `<div style="color:red; font-weight:bold; margin-bottom:10px;">DE SCHULD IS TE HOOG</div><p>De schuldeisers hebben je gevonden.</p>`;
                UI.modal("GAME OVER", gameOverHtml, '<button class="btn btn-action" onclick="window.Engine.reset()">HERSTART SPEL</button>');
                return;
            }

            // LAB LOGIC FIXED: Check inventory space before production
            let labYield = 0;
            if (state.hqUpgrades.includes('lab') && state.lab.chemicals > 0) {
                const currentInv = Object.values(state.inventory).reduce((a, b) => a + (b || 0), 0);
                const space = state.maxInv - currentInv;
                
                if (space > 0) {
                    const batchSize = Math.min(state.lab.chemicals, 20, space); 
                    state.lab.chemicals -= batchSize;
                    state.inventory['drugs'] = (state.inventory['drugs'] || 0) + batchSize;
                    
                    // Update costs for produced drugs - Assume cheap cost for lab made drugs (e.g. 50% of base)
                    const gid = 'drugs';
                    const baseCost = GOODS.find(g => g.id === gid).base * 0.5;
                    const currentCount = state.inventory[gid] || 0;
                    const currentCost = state.inventoryCosts[gid] || 0;
                    const newAvg = ((currentCount * currentCost) + (batchSize * baseCost)) / (currentCount + batchSize);
                    state.inventoryCosts[gid] = newAvg;
                    
                    labYield = batchSize;
                    state.heat += 4; 
                }
            }

            state.day++;
            
            // Income
            const districtInc = state.ownedDistricts.reduce((s, id) => s + DISTRICTS[id].income, 0);
            let businessInc = 0;
            let totalWashed = 0;
            if(state.ownedBusinesses) {
                state.ownedBusinesses.forEach(bid => {
                    const biz = BUSINESSES.find(b => b.id === bid);
                    if(biz) {
                        businessInc += biz.income;
                        let washAmount = Math.min(state.dirtyMoney, biz.clean);
                        state.dirtyMoney -= washAmount;
                        state.money += washAmount; 
                        totalWashed += washAmount;
                    }
                });
            }

            state.money += (districtInc + businessInc);
            if(state.debt > 0) state.debt = Math.floor(state.debt * 1.015); // 1.5% interest
            
            // Heat reduction
            const totalBrains = this.getPlayerStat('brains');
            let heatDrop = 8 + Math.floor(totalBrains / 2); 
            if(state.hqUpgrades.includes('server')) heatDrop += 10;
            const hackers = state.crew.filter(c => c.role === 'Hacker').length;
            heatDrop += (hackers * 3);
            state.heat = Math.max(0, state.heat - heatDrop);

            // Feedback
            let feedback = `Winst: €${(districtInc + businessInc).toLocaleString()}`;
            if (totalWashed > 0) feedback += ` | Wit: €${totalWashed.toLocaleString()}`;
            if (labYield > 0) feedback += ` | Lab: +${labYield} Drugs`;
            
            UI.toast(feedback, false);

            // Events
            if (state.heat > 80 && Math.random() < 0.20) return this.triggerBountyHunter();
            if (state.ownedDistricts.length > 0 && Math.random() < 0.12) return this.triggerRivalAttack();
            if (Math.random() < 0.15) { this.triggerShadowEvent(); return; }

            state.currentNews = NEWS_HEADLINES[Math.floor(Math.random() * NEWS_HEADLINES.length)];
            this.generatePrices(true);
            this.generateContracts(); 
            UI.render();
            await this.save();
        },

        triggerShadowEvent() {
            const evt = SHADOW_EVENTS[Math.floor(Math.random() * SHADOW_EVENTS.length)];
            let html = `<p>${evt.text}</p><div style="display:flex; flex-direction:column; gap:8px; margin-top:15px;">`;
            evt.options.forEach((opt, idx) => {
                html += `<button class="btn btn-choice" onclick="window.Engine.resolveShadowEvent('${evt.title}', '${opt.action}', ${opt.cost || 0})">${opt.text}</button>`;
            });
            html += `</div>`;
            UI.modal(evt.title, html, " ");
        },

        resolveShadowEvent(title, action, cost) {
            UI.closeModal();
            if (cost > 0 && state.money < cost) return UI.toast("Niet genoeg geld!", true);
            if (cost > 0) state.money -= cost;

            if (action === 'bribe' || action === 'pay') {
                UI.toast("Betaald. Je bent veilig.", false);
            } else if (action === 'run') {
                if (Math.random() > 0.5) UI.toast("Ontsnapt!", false);
                else { state.heat += 15; UI.toast("Gepakt! Heat +15%", true); }
            } else if (action === 'fight') {
                this.startCombat(0, { name: "Gangster", risk: 50, hp: 60 }); 
                return;
            } else if (action === 'deal') {
                // Update cost for shadow deal
                const gid = 'drugs';
                const buyPrice = 300; // Deal cost
                const currentCount = state.inventory[gid] || 0;
                const currentCost = state.inventoryCosts[gid] || 0;
                const newAvg = ((currentCount * currentCost) + buyPrice) / (currentCount + 1);
                state.inventoryCosts[gid] = newAvg;
                
                state.inventory[gid] = (state.inventory[gid] || 0) + 1;
                UI.toast("Deal gesloten.", false);
            } else if (action === 'loot') {
                state.money += 1000;
                UI.toast("Geld in de zak.", false);
            }
            this.generatePrices(true);
            UI.render();
            this.save();
        },

        getPlayerStat(statName) {
            let total = state.player.stats[statName];
            Object.values(state.player.loadout).forEach(itemId => {
                if (itemId) {
                    const item = GEAR.find(g => g.id === itemId);
                    if (item && item.stats && item.stats[statName]) total += item.stats[statName];
                }
            });
            return total;
        },

        gainXp(amount) {
            state.player.xp += amount;
            // FIX: Using while loop to handle multi-level ups
            while (state.player.xp >= state.player.nextXp) {
                state.player.xp -= state.player.nextXp;
                state.player.level++;
                state.player.nextXp = Math.floor(state.player.nextXp * 1.25);
                state.player.skillPoints++;
                UI.toast(`LEVEL UP! Nu level ${state.player.level}`);
            }
        },

        upgradeStat(stat) {
            if (state.player.skillPoints > 0) {
                state.player.stats[stat]++;
                state.player.skillPoints--;
                UI.render();
                this.save();
            }
        },

        buyGear(id) {
            const item = GEAR.find(g => g.id === id);
            if (state.ownedGear && state.ownedGear.includes(id)) return UI.toast("Al in bezit.");
            if (item.reqRep) {
                if ((state.familyRel[item.reqRep.f] || 0) < item.reqRep.val) return UI.toast(`Vereist ${item.reqRep.val} Rep bij ${FAMILIES[item.reqRep.f].name}.`, true);
            }
            if (state.money < item.cost) return UI.toast("Te weinig geld.", true);
            state.money -= item.cost;
            if (!state.ownedGear) state.ownedGear = [];
            state.ownedGear.push(id);
            UI.toast(`${item.name} gekocht.`);
            UI.render();
            this.save();
        },

        buyBusiness(id) {
            const biz = BUSINESSES.find(b => b.id === id);
            if (state.ownedBusinesses && state.ownedBusinesses.includes(id)) return UI.toast("Al in bezit.");
            if (state.money < biz.cost) return UI.toast("Onvoldoende kapitaal.", true);
            state.money -= biz.cost;
            if(!state.ownedBusinesses) state.ownedBusinesses = [];
            state.ownedBusinesses.push(id);
            this.gainXp(100);
            UI.toast(`${biz.name} aangeschaft!`);
            UI.render();
            this.save();
        },
        
        buyPrecursors() {
            if (state.money < 500) return UI.toast("Te weinig geld (€500 nodig).", true);
            state.money -= 500;
            state.lab.chemicals += 10;
            UI.toast("10 Chemicaliën gekocht.");
            UI.render();
            this.save();
        },

        equip(id) {
            const item = GEAR.find(g => g.id === id);
            if (!item) return;
            state.player.loadout[item.type] = id;
            UI.toast(`${item.name} uitgerust.`);
            UI.render();
            this.save();
        },

        unequip(slot) {
            if (state.player.loadout[slot]) {
                state.player.loadout[slot] = null;
                UI.render();
                this.save();
            }
        },
        
        healCrew(idx) {
            const crew = state.crew[idx];
            if (!crew) return;
            const missing = 100 - crew.hp;
            if (missing <= 0) return UI.toast("Al gezond.");
            const cost = missing * 5; 
            if (state.money < cost) return UI.toast(`Dokter kost €${cost}.`, true);
            state.money -= cost;
            crew.hp = 100;
            UI.toast(`${crew.name} genezen.`);
            UI.render();
            this.save();
        },

        promptPayDebt() {
            if (state.debt <= 0) return UI.toast("Geen schuld.");
            const maxPay = Math.min(state.money, state.debt);
            const content = `<p>Huidige schuld: <span style="color:var(--blood)">€${state.debt.toLocaleString()}</span></p><p>Beschikbaar: €${state.money.toLocaleString()}</p>`;
            const actions = `<button class="btn btn-gold" onclick="window.Engine.payDebt(5000)">BETAAL €5.000</button><button class="btn btn-action" onclick="window.Engine.payDebt(${maxPay})">BETAAL MAX (€${maxPay.toLocaleString()})</button><button class="btn" onclick="window.UI.closeModal()">ANNULEREN</button>`;
            UI.modal("WOEKERAAR TERUGBETALEN", content, actions);
        },

        payDebt(amount) {
            if (state.money < amount) return UI.toast("Onvoldoende geld.", true);
            if (state.debt <= 0) return;
            amount = Math.min(amount, state.debt);
            state.money -= amount;
            state.debt -= amount;
            UI.closeModal();
            UI.toast(`€${amount.toLocaleString()} afgelost.`);
            UI.render();
            this.save();
        },

        triggerBountyHunter() {
            let actions = '';
            state.crew.forEach((c, i) => { actions += `<button class="btn btn-choice" onclick="window.Engine.startCombat(${i}, {name: 'Hunter', risk: 80, hp: 100})">Stuur ${c.name}</button>`; });
            actions += `<button class="btn btn-action" onclick="window.Engine.surrenderBounty()">Betaal premie (€5.000)</button>`;
            UI.modal("BOUNTY HUNTER!", "Een Bounty Hunter heeft je HQ gevonden!", actions);
        },

        surrenderBounty() {
            if (state.money < 5000) return UI.toast("Niet genoeg geld!", true);
            state.money -= 5000;
            state.heat = 20;
            UI.closeModal();
            UI.toast("Premie betaald.", false);
            this.endTurn();
        },

        triggerRivalAttack() {
            const id = state.ownedDistricts[Math.floor(Math.random()*state.ownedDistricts.length)];
            const d = DISTRICTS[id];
            let actions = '';
            let defenseBonus = state.hqUpgrades.includes('security') ? 30 : 0;
            defenseBonus += (this.getPlayerStat('muscle') * 3);
            state.crew.forEach((c, i) => { actions += `<button class="btn btn-choice" onclick="window.Engine.defendDistrict('${id}', ${i}, ${defenseBonus})">Verdedig met ${c.name}</button>`; });
            actions += `<button class="btn btn-action" onclick="window.Engine.loseDistrict('${id}')">Geef district op</button>`;
            UI.modal("RIVALERENDE AANVAL", `Rivalen vallen <b>${d.name}</b> aan!`, actions);
        },

        defendDistrict(id, idx, bonus) {
            if ((Math.random() * 100) < (50 + bonus)) { 
                UI.closeModal();
                UI.toast("Aanval afgeslagen!");
                state.crew[idx].xp += 20;
                this.gainXp(10);
                this.endTurn();
            } else {
                this.startCombat(idx, { name: "Bendeoorlog", risk: 50, hp: 80 });
            }
        },

        loseDistrict(id) {
            state.ownedDistricts = state.ownedDistricts.filter(x => x !== id);
            UI.closeModal();
            UI.toast("Sector verloren.", true);
            this.endTurn();
        },

        washMoney() {
            if (state.dirtyMoney <= 0) return UI.toast("Geen zwart geld.", true);
            const amount = Math.min(state.dirtyMoney, 3000 + (state.ownedDistricts.length * 1000));
            state.dirtyMoney -= amount;
            state.money += Math.floor(amount * 0.85);
            state.heat += 8;
            this.gainXp(5);
            UI.toast(`€${amount} witgewassen.`);
            UI.render();
            this.save();
        },

        buyUpgrade(id) {
            const upg = HQ_UPGRADES.find(u => u.id === id);
            if(state.hqUpgrades.includes(id)) return UI.toast("Al in bezit.");
            if(state.money < upg.cost) return UI.toast("Te weinig geld.", true);
            state.money -= upg.cost;
            state.hqUpgrades.push(id);
            this.recalcStats();
            UI.toast(`${upg.name} geïnstalleerd.`);
            UI.render();
            this.save();
        },
        
        selectDistrict(id) { selectedDistrict = id; UI.renderMap(); },

        performDistrictAction() {
            const id = selectedDistrict;
            if(!id) return;
            
            if (state.loc === id) {
                const d = DISTRICTS[id];
                if (!state.ownedDistricts.includes(id)) {
                    if (state.money >= d.cost) {
                        state.money -= d.cost;
                        state.ownedDistricts.push(id);
                        this.gainXp(50);
                        UI.toast(`${d.name} overgenomen!`);
                        UI.render();
                        this.save();
                    } else { UI.toast("Onvoldoende geld.", true); }
                }
            } else {
                const hasChauffeur = state.crew.some(c => c.role === 'Chauffeur');
                const isOwned = state.ownedDistricts.includes(id);
                const travelCost = (hasChauffeur || isOwned) ? 0 : 50;
                if (state.money < travelCost) return UI.toast("Geen geld voor reisticket.", true);
                state.money -= travelCost;
                state.loc = id;
                UI.toast(`Aangekomen in ${DISTRICTS[id].name}`);
                 if (Math.random() < 0.1) { this.triggerShadowEvent(); return; }
                UI.render();
                this.save();
            }
        },

        travel(id) { this.selectDistrict(id); },

        trade(gid) {
            if (tradeDebounce) return;
            tradeDebounce = true;
            setTimeout(() => tradeDebounce = false, 200);

            if (tradeMode === 'buy' && state.loc !== selectedDistrict && selectedDistrict !== null) return UI.toast("Reis hierheen om te kopen.", true);
            const basePrice = state.prices[state.loc][gid];
            
            const totalCharm = this.getPlayerStat('charm');
            const charmBonus = (totalCharm * 0.02) + (state.rep / 5000); 
            const buyPrice = basePrice;
            const sellPrice = Math.floor(basePrice * 0.85 * (1 + charmBonus));

            if (tradeMode === 'buy') {
                const invCount = Object.values(state.inventory).reduce((a, b) => a + (b || 0), 0);
                if (state.money < buyPrice) return UI.toast("Te weinig kapitaal.", true);
                if (invCount >= state.maxInv) return UI.toast("Kofferbak vol.", true);
                
                state.money -= buyPrice;
                
                // --- UPDATE AVERAGE COST ---
                const currentCount = state.inventory[gid] || 0;
                const currentCost = state.inventoryCosts[gid] || 0;
                // Weighted average calculation
                const newAvg = ((currentCount * currentCost) + buyPrice) / (currentCount + 1);
                state.inventoryCosts[gid] = newAvg;
                
                state.inventory[gid] = (state.inventory[gid] || 0) + 1;
            } else {
                if (!state.inventory[gid] || state.inventory[gid] <= 0) return UI.toast("Niet op voorraad.", true);
                state.money += sellPrice;
                state.inventory[gid]--;
                
                // If inventory hits 0, reset cost to 0 for cleanliness, though not strictly required
                if (state.inventory[gid] <= 0) state.inventoryCosts[gid] = 0;
                
                state.rep += 2;
                this.gainXp(2); 
            }
            UI.render();
            this.save();
        },

        recruit() {
            if (state.money < 2500) return UI.toast("Onvoldoende geld.", true);
            state.money -= 2500;
            const roles = ['Chauffeur', 'Enforcer', 'Hacker', 'Smokkelaar'];
            const names = ['Vinny', 'Pauly', 'Luca', 'Vito', 'Rico', 'Bones', 'Tank', 'Mouse', 'Snake', 'Ghost'];
            state.crew.push({
                name: names[Math.floor(Math.random()*names.length)],
                role: roles[Math.floor(Math.random()*roles.length)],
                hp: 100, xp: 0, level: 1
            });
            this.recalcStats();
            UI.render();
            this.save();
        },

        bribePolice() {
            const totalCharm = this.getPlayerStat('charm');
            const cost = Math.max(1000, 3500 - (totalCharm * 150));
            if (state.money < cost) return UI.toast("Te duur.", true);
            state.money -= cost;
            state.policeRel = Math.min(100, state.policeRel + 20);
            state.heat = Math.max(0, state.heat - 15); 
            UI.toast("Politie relatie verbeterd & Heat verlaagd.");
            UI.render();
            this.save();
        },

        acceptContract(contractId, crewIdx) {
            // FIX: Convert ID to number because HTML onclick passes it as string
            const cId = Number(contractId);
            const contract = state.activeContracts.find(c => c.id === cId);
            if (!contract) return;
            
            const crew = state.crew[crewIdx];
            const muscle = this.getPlayerStat('muscle');
            const brains = this.getPlayerStat('brains');
            let statBonus = (muscle + brains) * 2.5;
            
            const heatPenalty = Math.min(30, state.heat / 2);
            let winChance = 100 - contract.risk - heatPenalty + (crew.level * 6) + statBonus;

            UI.closeModal();

            if (Math.random() * 100 < winChance) {
                state.dirtyMoney += contract.reward;
                state.rep += 20;
                state.heat += contract.heat;
                crew.xp += contract.xp;
                this.gainXp(contract.xp);
                
                state.familyRel[contract.employer] = Math.min(100, (state.familyRel[contract.employer] || 0) + 15);
                state.familyRel[contract.target] = Math.max(-100, (state.familyRel[contract.target] || 0) - 10);
                
                // FIX: Use number ID for filtering
                state.activeContracts = state.activeContracts.filter(c => c.id !== cId);

                if (crew.xp >= 100) { crew.level++; crew.xp = 0; UI.toast(`${crew.name} Level Up!`); }
                UI.toast(`${contract.name} geslaagd! Relatie ${FAMILIES[contract.employer].name} verbeterd.`, false);
            } else {
                this.startCombat(crewIdx, { name: "Contract Mislukt", risk: 50, hp: 60 });
            }
            UI.render();
            this.save();
        },
        
        assassinateLeader(fid, crewIdx) {
            const family = FAMILIES[fid];
            const crew = state.crew[crewIdx];
            UI.closeModal();
            this.startCombat(crewIdx, { name: family.contact + " (BOSS)", risk: 100, hp: 250, isBoss: true, familyId: fid });
        },

        startCombat(idx, target) {
            const crew = state.crew[idx];
            if (!crew) { UI.toast("Crew niet gevonden"); return; }
            
            let targetHP = target.hp || 100;
            // NEW: Ensure we track maxHP for UI bars
            let enemyMaxHP = target.hp || 100;
            
            let logs = [`[ALARM] ${target.name} (HP:${targetHP}) valt aan!`, `[INFO] Kies je strategie...`];
            state.activeCombat = { 
                idx, 
                targetName: target.name, 
                targetHP, 
                enemyMaxHP, // Store Max HP
                logs, 
                isBoss: target.isBoss || false, 
                familyId: target.familyId || null
            };
            this.save();
            window.Engine.combatState = state.activeCombat;
            this.restoreCombatUI();
        },

        restoreCombatUI() {
            const s = window.Engine.combatState;
            if(!s) return;
            const idx = s.idx;
            const crew = state.crew[idx];
            if(!crew) return; // safety

            const targetName = s.targetName;
            const targetHP = s.targetHP;
            const maxHP = s.enemyMaxHP || 100; // Fallback
            const enemyPct = Math.max(0, Math.min(100, (targetHP / maxHP) * 100));
            const playerPct = Math.max(0, Math.min(100, (crew.hp / 100) * 100)); // Assuming 100 max hp for player crew for now
            
            const html = `
                <div class="combat-arena">
                    <div class="combat-header">
                        <div class="fighter player">
                            <div class="fighter-name" style="color:var(--green)">${crew.name}</div>
                            <div class="hp-bar-wrap"><div id="cb-player-bar" class="hp-bar" style="width: ${playerPct}%"></div></div>
                            <div class="hp-text"><span id="cb-player-hp">${crew.hp}</span>/100 HP</div>
                        </div>
                        <div class="vs-badge">VS</div>
                        <div class="fighter enemy">
                            <div class="fighter-name" style="color:var(--blood)">${targetName}</div>
                            <div class="hp-bar-wrap"><div id="cb-enemy-bar" class="hp-bar enemy-bar" style="width: ${enemyPct}%"></div></div>
                            <div class="hp-text"><span id="cb-enemy-hp">${targetHP}</span>/${maxHP} HP</div>
                        </div>
                    </div>
                    <div class="combat-log" id="c-log" style="height:100px; margin-bottom:0;"></div>
                </div>
                
                <div class="combat-actions-grid">
                    <div class="combat-btn" onclick="window.Engine.combatRound('attack')">
                        <i data-lucide="sword" size="24"></i>
                        <span class="combat-btn-label">AANVAL</span>
                        <span class="combat-btn-sub">Muscle DMG</span>
                    </div>
                    <div class="combat-btn" onclick="window.Engine.combatRound('defend')">
                        <i data-lucide="shield" size="24"></i>
                        <span class="combat-btn-label">DEKKING</span>
                        <span class="combat-btn-sub">-50% DMG</span>
                    </div>
                    <div class="combat-btn" onclick="window.Engine.combatRound('trick')">
                        <i data-lucide="zap" size="24"></i>
                        <span class="combat-btn-label">TRUC</span>
                        <span class="combat-btn-sub">Brains Crit?</span>
                    </div>
                    <div class="combat-btn" onclick="window.Engine.combatRound('intimidate')">
                        <i data-lucide="skull" size="24"></i>
                        <span class="combat-btn-label">INTIMIDEER</span>
                        <span class="combat-btn-sub">Charm Debuff</span>
                    </div>
                </div>
                <button class="btn" style="width:100%; margin-top:10px;" onclick="window.Engine.combatFlee()">VLUCHT POGING</button>
            `;
            
            UI.modal("GEVECHT IN PROGRESS", html, " "); // Empty actions footer
            this.updateCombatLog();
            if(window.lucide) window.lucide.createIcons();
        },

        updateCombatLog() {
            const el = document.getElementById('c-log');
            if (el && window.Engine.combatState) { 
                el.innerHTML = window.Engine.combatState.logs.map(l => `<div>${l}</div>`).join(''); 
                setTimeout(() => el.scrollTop = el.scrollHeight, 10);
            }
        },

        combatRound(action) {
            const s = window.Engine.combatState;
            if(!s) return;
            const idx = s.idx;
            const crew = state.crew[idx];
            
            if(!crew) { UI.closeModal(); UI.toast("Combat Error: Crew missing"); return; }
            
            const logs = s.logs;
            const muscle = this.getPlayerStat('muscle');
            const brains = this.getPlayerStat('brains');
            const charm = this.getPlayerStat('charm');
            
            let dmg = 0; 
            let enemyDmg = Math.floor(Math.random() * 15) + 5; // Base enemy dmg
            let playerMsg = "";
            let enemyMsg = "";

            // --- Player Action Phase ---
            if (action === 'attack') {
                dmg = Math.floor(Math.random() * 20) + 10 + (muscle * 2.5);
                if (crew.role === 'Enforcer') dmg += 5;
                playerMsg = `> AANVAL: Je haalt uit met kracht!`;
            } 
            else if (action === 'defend') {
                dmg = Math.floor(Math.random() * 5) + muscle; // Small counter dmg
                enemyDmg = Math.floor(enemyDmg * 0.5); // 50% reduction
                playerMsg = `> DEKKING: Je blokkeert de aanval.`;
            }
            else if (action === 'trick') {
                if(Math.random() < 0.4 + (brains * 0.05)) {
                    dmg = Math.floor(Math.random() * 30) + 20 + (brains * 3);
                    playerMsg = `> TRUC: CRITICAL HIT! Slimme zet.`;
                } else {
                    dmg = Math.floor(Math.random() * 5);
                    playerMsg = `> TRUC: Mislukt...`;
                }
            }
            else if (action === 'intimidate') {
                dmg = Math.floor(Math.random() * 5) + charm;
                // Debuff logic could be complex, for now simple dmg reduction for this turn
                enemyDmg = Math.max(0, enemyDmg - (5 + charm)); 
                playerMsg = `> INTIMIDEER: De vijand aarzelt.`;
            }

            // --- Resolve Damage ---
            s.targetHP -= dmg;
            crew.hp -= enemyDmg;
            
            logs.push(playerMsg);
            if(dmg > 0) logs.push(`<span style="color:var(--green)">[HIT] -${dmg} HP bij vijand.</span>`);
            
            if (s.targetHP > 0) {
                logs.push(`<span style="color:var(--blood)">[HIT] Vijand doet -${enemyDmg} HP schade.</span>`);
                if(action === 'defend') logs.push(`<span style="color:#888; font-style:italic;">(Schade gehalveerd door dekking)</span>`);
            }

            // --- UI Updates (Direct DOM manipulation for speed) ---
            const pBar = document.getElementById('cb-player-bar');
            const eBar = document.getElementById('cb-enemy-bar');
            const pHp = document.getElementById('cb-player-hp');
            const eHp = document.getElementById('cb-enemy-hp');
            
            if(pBar && eBar) {
                const maxEnemy = s.enemyMaxHP || 100;
                pBar.style.width = `${Math.max(0, crew.hp)}%`;
                eBar.style.width = `${Math.max(0, (s.targetHP / maxEnemy) * 100)}%`;
                pHp.innerText = Math.max(0, crew.hp);
                eHp.innerText = Math.max(0, s.targetHP);
                
                // Shake effect on damage
                if(enemyDmg > 0) {
                    const modal = document.getElementById('modal-box');
                    if(modal) {
                        modal.classList.remove('shake-anim');
                        void modal.offsetWidth; // trigger reflow
                        modal.classList.add('shake-anim');
                    }
                }
            }

            // --- Win/Loss Check ---
            if (s.targetHP <= 0) {
                logs.push(`[WIN] ${s.targetName} is verslagen!`);
                crew.xp += 50;
                this.gainXp(25);
                
                if (s.isBoss) {
                     state.leadersDefeated.push(s.familyId);
                     state.rep += 500;
                     setTimeout(() => UI.modal("KINGPIN STATUS", `${s.targetName} is dood. Hun gebied is nu kwetsbaar.`), 1000);
                } else {
                     setTimeout(() => UI.modal("GEWONNEN", "Vijand verslagen. Je crew overleeft."), 500);
                }
                state.activeCombat = null;
            } 
            else if (crew.hp <= 0) {
                state.crew.splice(idx, 1);
                state.activeCombat = null; 
                this.recalcStats(); 
                setTimeout(() => UI.modal("VERLOREN", `<span style="color:var(--blood)">${crew.name}</span> is gesneuveld in het gevecht.`), 500);
            }

            // --- Save State ---
            s.logs = logs; // update logs in state
            this.save();
            this.updateCombatLog();
            this.checkWinCondition();
        },

        combatFlee() {
             if (Math.random() > 0.4) { 
                 state.activeCombat = null; this.save();
                 UI.closeModal(); UI.modal("VLUCHT", "Je bent ontsnapt."); 
             } else {
                 const logs = window.Engine.combatState.logs;
                 logs.push(`<span style="color:var(--gold)">> Vlucht mislukt! Vijand blokkeert de weg.</span>`);
                 // Enemy free hit
                 this.combatRound('flee_fail'); // Trigger a round where player does nothing? 
                 // Actually simpler to just update log here, but let's keep it consistent:
                 this.updateCombatLog();
             }
        },

        checkWinCondition() {
            if (state.ownedDistricts.length >= 5 && state.money >= 5000000 && state.leadersDefeated.length >= 3) {
                 const winHtml = `<div style="color:var(--gold); font-size:1.5rem; text-align:center;">KINGPIN VAN NOXHAVEN</div><p>Je hebt alles. De stad is van jou.</p><p>Dagen: ${state.day} | Vermogen: €${state.money.toLocaleString()}</p>`;
                 UI.modal("GEWONNEN", winHtml, '<button class="btn btn-action" onclick="window.Engine.reset()">NIEUWE HEERSAPPIJ STARTEN</button>');
            }
        }
    };

    window.Engine = Engine; window.UI = UI;
    window.onload = () => { Engine.init(); };
</script>
</body>
</html>
